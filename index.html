<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Bee Clicker: Royal Edition üêù</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffcc00">

<style>
:root{
  --bg1:#87ceeb; --bg2:#fff3b0; --card:#fff;
  --accent:#ffcc00; --dark:#4a3b00; --shadow:0 10px 30px rgba(0,0,0,0.15);
  --xp-bar:#4caf50;
  --common: #b2bec3; --rare: #0984e3; --epic: #a29bfe;
}

*{ box-sizing:border-box; user-select:none; -webkit-tap-highlight-color:transparent; }

body, html {
  margin:0; padding: 0; width: 100%; height: 100%;
  font-family:system-ui, -apple-system, sans-serif;
  background: linear-gradient(180deg, var(--bg1), var(--bg2));
  background-attachment: fixed;
  overflow: hidden;
}

body { display: flex; align-items: center; justify-content: center; min-height: 100svh; }

/* TELA INICIAL NATALINA */
#startScreen {
    position: fixed; inset: 0; background: linear-gradient(180deg, #1e3799, #0c2461);
    z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s ease;
}
.snow-container { position: absolute; inset: 0; pointer-events: none; z-index: 1; }
.snowflake { position: absolute; color: white; font-size: 1.2em; top: -20px; animation: fall linear infinite; }
@keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

.start-bee-wrapper { position: relative; z-index: 2; margin-bottom: 20px; }
.start-logo { font-size: 100px; animation: floatBee 3s infinite ease-in-out; }

.start-title { 
    font-size: clamp(30px, 10vw, 42px); font-weight: 900; color: white; margin: 20px 0; 
    text-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2;
    display: flex; align-items: center; justify-content: center;
}

.letter-i-wrapper { position: relative; display: inline-flex; justify-content: center; color: white; }
.tree-overlay {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -58%);
    font-size: 1.1em; pointer-events: none;
}

/* INTERFACE DO JOGO */
.game{ width:100%; max-width:420px; height: 100vh; padding:14px; position: relative; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.5s; z-index: 10; }
.card{ background:var(--card); border-radius:26px; padding:20px; box-shadow:var(--shadow); text-align:center; position: relative; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.4); }

.notif-card { height: 65px; display: flex; align-items: center; padding: 0 20px; overflow: hidden; background: #fff; flex-shrink: 0; }
#notifContainer { flex: 1; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }

.save-icon { position: absolute; left: 18px; top: 22px; font-size: 18px; opacity: 0; transition: 0.3s; z-index: 10; }
.save-icon.visible { opacity: 1; animation: pulseSave 1s ease-out; }
@keyframes pulseSave { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

.top-btns { position: absolute; right: 18px; top: 18px; display: flex; gap: 10px; }
.circle-btn { background: #f2f2f2; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }

.level-container { margin-top: 12px; text-align: left; }
.level-info { display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; margin-bottom: 6px; color: var(--dark); }
.xp-bg { width: 100%; height: 12px; background: #eee; border-radius: 12px; overflow: hidden; }
.xp-fill { height: 100%; background: var(--xp-bar); width: 0%; transition: width 0.5s; }
.stats{ margin-top:8px; font-size:18px; font-weight: 800; color: var(--dark); }

.click-zone { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 180px; position: relative; touch-action: none; }
.aura-wrapper { position: relative; width: 110px; height: 110px; display: flex; justify-content: center; align-items: center; }
.aura { position: absolute; width: 150px; height: 150px; border-radius: 50%; filter: blur(25px); opacity: 0.3; background: radial-gradient(circle, rgba(255,204,0,0.5), transparent 70%); transition: 0.2s; }

.bee-container { position: relative; z-index: 2; animation: floatBee 3s infinite ease-in-out; cursor: pointer; transition: transform 0.05s; }
.bee { font-size: 75px; }
.bee-accessory { position: absolute; top: -25px; left: 42%; transform: translateX(-50%); font-size: 38px; display: none; pointer-events: none; z-index: 3; }

@keyframes floatBee { 0%, 100%{transform:translateY(0) rotate(0deg);} 50%{transform:translateY(-12px) rotate(3deg);} }
.target { height: 65px; width: 65px; border-radius: 20px; border: 3px dashed #ffeb3b; display: flex; align-items: center; justify-content: center; font-size: 28px; opacity: 0.7; }

#active-boosts { position: absolute; top: 5px; width: 100%; display: flex; justify-content: center; gap: 8px; pointer-events: none; }
.active-boost-timer { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 10px; border: 1px solid var(--accent); font-size: 11px; font-weight: 900; }

.main-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--card); border-radius: 26px 26px 0 0; box-shadow: var(--shadow); margin-bottom: -14px; }
.tabs-header { display: flex; background: #f8f8f8; border-bottom: 1px solid #eee; flex-shrink: 0; }
.tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: 800; color: #999; cursor: pointer; font-size: 13px; }
.tab-btn.active { color: var(--dark); border-bottom: 3px solid var(--accent); background: #fff; }

.tabs-content { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; touch-action: pan-y; }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

.shop-nav { display: flex; gap: 10px; margin-bottom: 15px; }
.sub-tab-btn { flex: 1; padding: 8px; border-radius: 10px; border: 1px solid #eee; background: #f9f9f9; font-size: 11px; font-weight: 800; cursor: pointer; }
.sub-tab-btn.active { background: var(--accent); border-color: var(--dark); }

.shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 8px; }
.buy-btn-small { padding: 8px 4px; font-size: 10px; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

button{ width:100%; padding:15px; margin-top:8px; border:none; border-radius:15px; font-size:14px; font-weight:800; background:var(--accent); color:var(--dark); box-shadow:0 4px 0 #d1ad00; cursor: pointer; }
button:active{ transform:translateY(2px); box-shadow:0 2px 0 #d1ad00; }
button:disabled { background:#e0e0e0 !important; color:#aaa !important; box-shadow: none !important; }

.ach-card { display: flex; align-items: center; padding: 12px; border-radius: 15px; background: #fcfcfc; border: 2px solid #eee; text-align: left; gap: 12px; margin-bottom: 8px; }
.ach-card.unlocked.common { border-color: var(--common); }
.ach-card.unlocked.rare { border-color: var(--rare); background: #f0f8ff; }
.ach-card.unlocked.epic { border-color: var(--epic); background: #f5f0ff; }

.filter-sticky-header { position: sticky; top: -15px; background: #fff; z-index: 10; padding: 10px 0; border-bottom: 1px solid #f0f0f0; margin-bottom: 15px; }
.filter-bar { display: flex; justify-content: center; gap: 10px; }
.filter-dot { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #eee; background: white; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; }
.filter-dot.active { border-color: var(--dark); background: var(--accent); }

.modal{ position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter: blur(6px); display:none; justify-content:center; align-items:center; z-index:5000; padding: 20px; }
.modal-box{ background:#fff; width:100%; max-width:400px; border-radius:30px; overflow:hidden; }
.modal-header{ padding:20px; background: var(--accent); font-weight:900; display:flex; justify-content:space-between; color: var(--dark); }

.popup { position: absolute; background: #fff; padding: 8px 18px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-weight: 800; font-size: 11px; border-left: 6px solid var(--accent); animation: slideInOut 4s ease-in-out forwards; pointer-events: none; z-index: 10000; }
@keyframes slideInOut { 0% { transform: translateX(-140%); opacity: 0; } 8% { transform: translateX(0); opacity: 1; } 92% { transform: translateX(0); opacity: 1; } 100% { transform: translateX(140%); opacity: 0; } }

.version-tag { color: rgba(255,255,255,0.5); margin-top: 15px; font-weight: bold; font-size: 12px; }
</style>
</head>

<body oncontextmenu="return false;">

<div id="startScreen">
    <div class="snow-container" id="snowContainer"></div>
    <div class="start-bee-wrapper">
        <div class="start-logo">üêù</div>
    </div>
    <div class="start-title">
        BEE CL<span class="letter-i-wrapper">I<span class="tree-overlay">üéÑ</span></span>CKER
    </div>
    <button style="width: 240px; font-size: 18px;" onclick="enterGame()">JOGAR AGORA</button>
    <div class="version-tag">VERS√ÉO 3.0.0 (STABLE)</div>
</div>

<div class="game" id="gameUI">
  <div class="card">
    <div id="saveIndicator" class="save-icon">üíæ</div>
    <div class="top-btns"><button class="circle-btn" id="btnHelp">‚ùì</button></div>
    <div style="font-size: 20px; font-weight: 900; margin-top: 5px;">Bee Clicker üêù</div>
    <div class="stats">üçØ <span id="honey">0</span> | ‚ö° <span id="mps">0</span>/s</div>
    <div class="level-container">
      <div class="level-info"><span>N√≠vel <span id="lvlDisplay">1</span></span><span id="xpDisplay">0 / 1.0K</span></div>
      <div class="xp-bg"><div class="xp-fill" id="xpFill"></div></div>
    </div>
  </div>

  <div class="card notif-card">
      <div id="notifContainer"></div>
  </div>

  <div class="card" style="padding: 10px;">
    <div id="active-boosts"></div>
    <div class="click-zone" id="clickZone">
      <div class="target" id="leftTarget">üéØ</div>
      <div class="aura-wrapper">
        <div class="aura" id="aura"></div>
        <div class="bee-container" id="beeContainer">
            <div class="bee-accessory" id="acc_crown">üëë</div>
            <div class="bee-accessory" id="acc_santa">üßë‚ÄçüéÑ</div>
            <div class="bee">üêù</div>
        </div>
      </div>
      <div class="target" id="rightTarget">üéØ</div>
    </div>
  </div>

  <div class="main-panel">
      <div class="tabs-header">
          <button class="tab-btn active" onclick="openTab('upgrades', this)">UPGRADES</button>
          <button class="tab-btn" onclick="openTab('shop', this)">LOJA</button>
          <button class="tab-btn" onclick="openTab('achievements', this)">CONQUISTAS</button>
      </div>
      
      <div class="tabs-content" id="mainScrollArea">
          <div id="upgrades" class="tab-pane active">
              <button id="btnUpgradeClick">Upgrade Clique ‚Äì 10 üçØ</button>
              <button id="btnAutoAction">Desbloquear Auto ‚Äì 100 üçØ</button>
          </div>

          <div id="shop" class="tab-pane">
              <div class="shop-nav">
                  <button class="sub-tab-btn active" onclick="openSubShop('boosts', this)">BOOSTS</button>
                  <button class="sub-tab-btn" onclick="openSubShop('cosmetics', this)">COSM√âTICOS</button>
              </div>

              <div id="shop_boosts" class="sub-shop-pane">
                  <div class="shop-section">
                      <div style="font-weight:900;">üå∂Ô∏è Pimenta (3x Mel)</div>
                      <small id="status_pepper" style="font-size:10px; color:#666;">Inativo</small>
                      <div class="shop-grid" id="grid_pepper"></div>
                  </div>
                  <div class="shop-section">
                      <div style="font-weight:900; margin-top:10px;">ü•§ Energ√©tico (2x Vel)</div>
                      <small id="status_energy" style="font-size:10px; color:#666;">Inativo</small>
                      <div class="shop-grid" id="grid_energy"></div>
                  </div>
                  <div class="shop-section">
                      <div style="font-weight:900; margin-top:10px;">üåº Flor (5x XP)</div>
                      <small id="status_flower" style="font-size:10px; color:#666;">Inativo</small>
                      <div class="shop-grid" id="grid_flower"></div>
                  </div>
              </div>

              <div id="shop_cosmetics" class="sub-shop-pane" style="display:none;">
                  <div class="shop-section">
                      <div style="font-weight:900;">üëî Guarda-Roupa Real</div>
                      <div class="shop-grid">
                          <button class="buy-btn-small" id="btn_cos_crown" onclick="handleCosmetic('crown', 50000)"><b>Coroa</b><br>50.0K üçØ</button>
                          <button class="buy-btn-small" id="btn_cos_santa" onclick="handleCosmetic('santa', 100000)"><b>Gorro Natal</b><br>100K üçØ</button>
                      </div>
                  </div>
              </div>
          </div>

          <div id="achievements" class="tab-pane">
              <div class="filter-sticky-header">
                  <div class="filter-bar">
                      <div class="filter-dot active" onclick="setAchFilter('all', this)">üåê</div>
                      <div class="filter-dot" onclick="setAchFilter('common', this)">‚ö™</div>
                      <div class="filter-dot" onclick="setAchFilter('rare', this)">üîµ</div>
                      <div class="filter-dot" onclick="setAchFilter('epic', this)">üü£</div>
                  </div>
              </div>
              <div id="achList"></div>
          </div>
      </div>
  </div>
</div>

<div class="modal" id="offlineModal">
    <div class="modal-box">
        <div class="modal-header">üêù Mel de Descanso</div>
        <div style="text-align:center; padding:30px;">
            <div style="font-size:60px;">üçØ</div>
            <p id="offlineText" style="font-weight:bold; margin: 15px 0;"></p>
            <button id="btnCollectOffline" style="background:var(--xp-bar); color:white; box-shadow:0 4px 0 #2d6630;">COLETAR TUDO</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURA√á√ÉO S√äNIOR ---
const SAVE_KEY = "BeeRoyal_Balance_V2";

// Estado Global
let honey = 0;
let totalHoneyEver = 0;
let hPerClick = 1;
let clickCost = 10;
let level = 1;
let currentXP = 0;
let nextLevelXP = 1000;
let autoUnlocked = false;
let autoLevel = 1;
let autoCost = 100;
let currentFilter = 'all';
let equippedCosmetic = null;
let ownedCosmetics = [];
let activeBoosts = { pepper: 0, energy: 0, flower: 0 };
let pendingOfflineHoney = 0;
let gameLoaded = false;
let clickBuffer = [];

const durations = [
    { label: "30s", t: 300, m: 1 }, 
    { label: "1m", t: 600, m: 1.8 }, 
    { label: "5m", t: 3000, m: 8 },
    { label: "1h", t: 36000, m: 70 }, 
    { label: "24h", t: 864000, m: 1200 }
];

const boostBases = { pepper: 500, energy: 300, flower: 1000 };

// --- SISTEMA DE CONQUISTAS ---
const achievements = [];
function initAchievements() {
    achievements.length = 0;
    for(let i=1; i<=200; i++) {
        let val = Math.pow(1.6, i) * 100;
        let rar = i < 80 ? "common" : (i < 160 ? "rare" : "epic");
        achievements.push({ 
            id: i, 
            n: `Meta #${i}`, 
            d: `Mel total: ${formatNum(val)}`, 
            c: () => totalHoneyEver >= val, 
            u: false, 
            r: rar, 
            i: "üçØ" 
        });
    }
}
initAchievements();

// --- UTILIT√ÅRIOS ---
function formatNum(n) {
    if (n >= 1e15) return (n/1e15).toFixed(2) + "Q";
    if (n >= 1e12) return (n/1e12).toFixed(2) + "T";
    if (n >= 1e9) return (n/1e9).toFixed(2) + "B";
    if (n >= 1e6) return (n/1e6).toFixed(1) + "M";
    if (n >= 1000) return (n/1000).toFixed(1) + "K";
    return Math.floor(n).toString();
}

function formatTime(t) {
    let s = Math.ceil(t/10);
    if(s < 60) return s + "s";
    if(s < 3600) return Math.floor(s/60) + "m";
    return Math.floor(s/3600) + "h " + Math.floor((s%3600)/60) + "m";
}

function getGlobalBonus() {
    let r = achievements.filter(a => a.u && a.r === 'rare').length;
    let e = achievements.filter(a => a.u && a.r === 'epic').length;
    let m = 1 + (r * 0.02) + (e * 0.10);
    if(activeBoosts.pepper > 0) m *= 3;
    if(activeBoosts.energy > 0) m *= 2;
    return m;
}

// --- INTERFACE (UI) ---
function updateUI() {
    document.getElementById("honey").textContent = formatNum(honey);
    
    let mps = autoUnlocked ? (2 * autoLevel) * getGlobalBonus() : 0;
    document.getElementById("mps").textContent = formatNum(mps);
    
    document.getElementById("lvlDisplay").textContent = level;
    document.getElementById("xpDisplay").textContent = `${formatNum(currentXP)} / ${formatNum(nextLevelXP)}`;
    document.getElementById("xpFill").style.width = `${Math.min(100, (currentXP / nextLevelXP) * 100)}%`;
    
    document.getElementById("btnUpgradeClick").disabled = (honey < clickCost);
    document.getElementById("btnUpgradeClick").innerHTML = `Upgrade Clique<br>${formatNum(clickCost)} üçØ`;

    document.getElementById("btnAutoAction").disabled = (honey < autoCost);
    document.getElementById("btnAutoAction").innerHTML = !autoUnlocked ? `Desbloquear Auto<br>${formatNum(autoCost)} üçØ` : `Upgrade Auto (Lvl ${autoLevel})<br>${formatNum(autoCost)} üçØ`;

    // Loja de Boosts
    ['pepper', 'energy', 'flower'].forEach(type => {
        const status = document.getElementById(`status_${type}`);
        if(status) status.textContent = activeBoosts[type] > 0 ? `Restante: ${formatTime(activeBoosts[type])}` : "Inativo";
        durations.forEach(d => {
            const btn = document.getElementById(`buy_${type}_${d.t}`);
            if(btn){
                const cost = Math.floor(boostBases[type] * level * d.m);
                btn.innerHTML = `<b>${d.label}</b><br>${formatNum(cost)}`;
                btn.disabled = (honey < cost);
            }
        });
    });

    updateCosmeticButton('crown', 50000);
    updateCosmeticButton('santa', 100000);

    // Badges de Boosts Ativos
    const badgeContainer = document.getElementById("active-boosts");
    badgeContainer.innerHTML = "";
    for(let b in activeBoosts) if(activeBoosts[b] > 0) {
        const icon = b === 'pepper' ? 'üå∂Ô∏è' : b === 'energy' ? 'ü•§' : 'üåº';
        badgeContainer.innerHTML += `<div class="active-boost-timer"><span>${icon} ${formatTime(activeBoosts[b])}</span></div>`;
    }
}

function updateCosmeticButton(id, cost) {
    const btn = document.getElementById(`btn_cos_${id}`);
    const acc = document.getElementById(`acc_${id}`);
    if(!btn || !acc) return;
    if (equippedCosmetic === id) { 
        btn.textContent = "EQUIPADO"; 
        btn.style.background = "var(--xp-bar)"; 
        acc.style.display = "block"; 
    }
    else if (ownedCosmetics.includes(id)) { 
        btn.textContent = "EQUIPAR"; 
        btn.style.background = "var(--rare)"; 
        acc.style.display = "none"; 
    }
    else { 
        btn.innerHTML = `<b>${id==='crown'?'Coroa':'Gorro'}</b><br>${formatNum(cost)}`; 
        btn.disabled = (honey < cost); 
        acc.style.display = "none"; 
    }
}

// --- L√ìGICA DE JOGO ---
function doClick() {
    const g = hPerClick * getGlobalBonus();
    honey += g;
    totalHoneyEver += g;
    addXP(g);
    
    // Feedback visual
    const bee = document.getElementById("beeContainer");
    bee.style.transform = "scale(0.9)";
    setTimeout(() => bee.style.transform = "scale(1)", 50);
    
    updateUI();
    clickBuffer.push(Date.now());
}

function addXP(amt) {
    let m = (activeBoosts.flower > 0) ? 5 : 1;
    currentXP += (amt * m);
    while(currentXP >= nextLevelXP){
        currentXP -= nextLevelXP;
        level++;
        nextLevelXP = Math.floor(nextLevelXP * 1.5);
        notify({n:`N√≠vel Real ${level}!`});
    }
}

function buyBoost(type, ticks, mult) {
    const cost = Math.floor(boostBases[type] * level * mult);
    if(honey >= cost) { 
        honey -= cost; 
        activeBoosts[type] += ticks; 
        updateUI(); 
        executeSave(); 
    }
}

function handleCosmetic(id, cost) {
    if (ownedCosmetics.includes(id)) {
        equippedCosmetic = (equippedCosmetic === id) ? null : id;
    } else if (honey >= cost) {
        honey -= cost;
        ownedCosmetics.push(id);
        notify({n: "Estilo Real Adquirido!"});
    }
    updateUI();
    executeSave();
}

function calculateOffline(ticks) {
    let mps = (2 * autoLevel) * getGlobalBonus();
    let total = (ticks / 10) * mps * 0.5; // Coleta 50% em offline
    return total;
}

function startAutoProducing() {
    setInterval(() => {
        if(autoUnlocked){
            let gain = (2 * autoLevel) * getGlobalBonus();
            honey += gain;
            totalHoneyEver += gain;
        }
    }, 1000);
}

// --- PERSIST√äNCIA (SAVE) ---
function executeSave(){ 
    if(!gameLoaded) return; 
    const data = {
        honey, totalHoneyEver, hPerClick, clickCost, 
        level, currentXP, nextLevelXP, 
        autoUnlocked, autoLevel, autoCost, 
        activeBoosts, ownedCosmetics, equippedCosmetic, 
        achs: achievements.map(a => a.u), 
        timestamp: Date.now()
    }; 
    localStorage.setItem(SAVE_KEY, JSON.stringify(data)); 
    
    const indicator = document.getElementById("saveIndicator");
    indicator.classList.add("visible");
    setTimeout(() => indicator.classList.remove("visible"), 1000);
}

function load(){
    const raw = localStorage.getItem(SAVE_KEY);
    if(raw){
        try {
            const d = JSON.parse(raw);
            honey = d.honey || 0;
            totalHoneyEver = d.totalHoneyEver || 0;
            hPerClick = d.hPerClick || 1;
            clickCost = d.clickCost || 10;
            level = d.level || 1;
            currentXP = d.currentXP || 0;
            nextLevelXP = d.nextLevelXP || 1000;
            autoUnlocked = d.autoUnlocked || false;
            autoLevel = d.autoLevel || 1;
            autoCost = d.autoCost || 100;
            if(d.activeBoosts) activeBoosts = d.activeBoosts;
            if(d.ownedCosmetics) ownedCosmetics = d.ownedCosmetics;
            if(d.equippedCosmetic) equippedCosmetic = d.equippedCosmetic;
            
            const elapsed = d.timestamp ? Math.floor((Date.now() - d.timestamp) / 100) : 0;
            if(autoUnlocked && elapsed > 100) {
                pendingOfflineHoney = calculateOffline(elapsed);
                document.getElementById("offlineText").textContent = `Voc√™ produziu ${formatNum(pendingOfflineHoney)} mel enquanto descansava!`;
                openModal('offlineModal');
            }
            
            if(d.achs) d.achs.forEach((u, i) => { if(achievements[i]) achievements[i].u = u; });
            
            if(autoUnlocked) startAutoProducing();
        } catch(e) { console.error("Falha no Load", e); }
    }
    gameLoaded = true; 
    buildShop(); 
    updateUI();
}

// --- GERENCIAMENTO DE TABS ---
function openTab(id, btn) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if(id === 'achievements') renderAchs();
}

function openSubShop(id, btn) {
    document.querySelectorAll('.sub-shop-pane').forEach(p => p.style.display = 'none');
    document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('shop_'+id).style.display = 'block';
    btn.classList.add('active');
}

function buildShop() {
    ['pepper', 'energy', 'flower'].forEach(type => {
        const grid = document.getElementById(`grid_${type}`);
        if(!grid) return;
        grid.innerHTML = "";
        durations.forEach(d => {
            const btn = document.createElement("button");
            btn.className = "buy-btn-small";
            btn.id = `buy_${type}_${d.t}`;
            btn.onclick = () => buyBoost(type, d.t, d.m);
            grid.appendChild(btn);
        });
    });
}

function renderAchs() {
    const l = document.getElementById("achList");
    l.innerHTML = "";
    achievements.filter(a => currentFilter === 'all' || a.r === currentFilter).forEach(a => {
        l.innerHTML += `
            <div class="ach-card ${a.u ? 'unlocked ' + a.r : 'locked'}">
                <div style="font-size: 24px;">${a.u ? a.i : 'üîí'}</div>
                <div>
                    <b style="color:var(--dark)">${a.n}</b><br>
                    <small style="color:#666">${a.d}</small>
                </div>
            </div>`;
    });
}

function setAchFilter(f, b) {
    currentFilter = f;
    document.querySelectorAll('.filter-dot').forEach(d => d.classList.remove('active'));
    b.classList.add('active');
    renderAchs();
}

function notify(a) {
    const container = document.getElementById("notifContainer");
    const div = document.createElement("div");
    div.className = `popup`;
    div.innerHTML = `‚ú® ${a.n}`;
    container.appendChild(div);
    setTimeout(() => div.remove(), 4000);
}

// --- LOOP PRINCIPAL (ENGINE) ---
setInterval(() => {
    if(!gameLoaded) return;
    
    // Anima√ß√£o por CPS
    const now = Date.now();
    clickBuffer = clickBuffer.filter(t => now - t < 1000);
    const cps = clickBuffer.length;
    
    const aura = document.getElementById("aura");
    const beeContainer = document.getElementById("beeContainer");
    
    if(aura) {
        let s = 1 + (cps * 0.1);
        aura.style.transform = `scale(${Math.min(s, 2)})`;
        aura.style.opacity = 0.3 + (cps * 0.1);
    }
    if(beeContainer) {
        beeContainer.style.animationDuration = cps > 5 ? '0.5s' : '3s';
    }

    // Checar Conquistas
    achievements.forEach(a => {
        if(!a.u && a.c()){
            a.u = true;
            notify(a);
            executeSave();
        }
    });

    // Tick de Boosts
    for(let b in activeBoosts) if(activeBoosts[b] > 0) activeBoosts[b]--;
    
    // Refresh UI a cada 1 segundo (ou menos se necess√°rio)
    if(now % 1000 < 150) updateUI();
}, 100);

// Auto-save a cada 15 segundos
setInterval(executeSave, 15000);

// --- CONTROLES ---
function enterGame() {
    document.getElementById('startScreen').style.opacity = '0';
    setTimeout(() => {
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('gameUI').style.opacity = '1';
    }, 500);
}

document.getElementById("btnHelp").onclick = () => {
    alert("Como jogar: Clique na abelha e alvos laterais. Use boosts para acelerar e conquistas para ganhar b√¥nus reais!");
};

document.getElementById("btnCollectOffline").onclick = () => {
    honey += pendingOfflineHoney;
    totalHoneyEver += pendingOfflineHoney;
    pendingOfflineHoney = 0;
    closeModal('offlineModal');
    updateUI();
    executeSave();
};

document.getElementById("btnUpgradeClick").onclick = () => {
    if(honey >= clickCost){
        honey -= clickCost;
        hPerClick += 1;
        clickCost = Math.floor(clickCost * 1.9);
        updateUI();
        executeSave();
    }
};

document.getElementById("btnAutoAction").onclick = () => {
    if(honey >= autoCost){
        honey -= autoCost;
        if(!autoUnlocked){
            autoUnlocked = true;
            autoCost = 500;
            startAutoProducing();
        } else {
            autoLevel++;
            autoCost = Math.floor(autoCost * 2.2);
        }
        updateUI();
        executeSave();
    }
};

// --- INPUTS ---
["clickZone", "beeContainer", "leftTarget", "rightTarget"].forEach(id => {
    const el = document.getElementById(id);
    if(el){
        el.addEventListener("mousedown", (e) => { e.preventDefault(); doClick(); });
        el.addEventListener("touchstart", (e) => { 
            e.preventDefault(); 
            for (let i = 0; i < e.changedTouches.length; i++) { doClick(); } 
        }, {passive: false});
    }
});

// Inicializa√ß√£o Final
function createSnow() {
    const container = document.getElementById('snowContainer');
    if(!container) return;
    for(let i=0; i<40; i++) {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.innerHTML = '‚ùÑ';
        flake.style.left = Math.random() * 100 + 'vw';
        flake.style.opacity = Math.random();
        flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
        flake.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(flake);
    }
}

createSnow();
load();
</script>
</body>
</html>