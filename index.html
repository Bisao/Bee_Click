<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>BeeKind üêù</title>

<link rel="icon" type="image/png" href="NoelBeeUp.png">
<link rel="apple-touch-icon" href="NoelBeeUp.png">
<link rel="shortcut icon" href="NoelBeeUp.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#071B87">
<link rel="manifest" href="manifest.json">

<style>
:root{
  --main-blue: #071B87;
  --bg-gradient: linear-gradient(180deg, var(--main-blue), #030d45);
  --card-opacity: 0.85;
  --card: linear-gradient(145deg, rgba(7, 27, 135, var(--card-opacity)), rgba(3, 13, 69, 0.9));
  --accent:#ffcc00; 
  --dark:#ffffff;
  --text-color: #ffffff; 
  --shadow:0 10px 30px rgba(0,0,0,0.3);
  --xp-bar:#4caf50;
  --common: #b2bec3; 
  --rare: #0984e3; 
  --epic: #a29bfe;
  --panel-blur: blur(15px);
  --crown-gold: #ffea00;
}

*{ 
    box-sizing:border-box; 
    user-select:none; 
    -webkit-tap-highlight-color:transparent; 
    touch-action: manipulation; 
}

body, html {
  margin:0; padding: 0; width: 100%; height: 100%;
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg-gradient);
  background-attachment: fixed;
  overflow: hidden;
  color: var(--text-color);
  transition: background 0.3s ease, color 0.3s ease;
  touch-action: none;
}

body { display: flex; align-items: center; justify-content: center; min-height: 100svh; }

.bee-img {
    width: 90px;
    height: 90px;
    object-fit: contain;
}
.bee-img-large {
    width: 140px;
    height: 140px;
    object-fit: contain;
    filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4));
}

.skin-preview {
    width: 40px;
    height: 40px;
    object-fit: contain;
    margin-bottom: 5px;
}

/* TELA DE LOADING */
#loadingScreen {
    position: fixed; inset: 0; background: var(--bg-gradient);
    z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center;
}
.loading-container { width: 80%; max-width: 300px; position: relative; }
.loading-bar-bg { width: 100%; height: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); overflow: visible; position: relative; }
.loading-bar-fill { height: 100%; background: var(--accent); width: 0%; border-radius: 10px; transition: width 0.1s linear; }
.loading-bee { 
    position: absolute; top: -45px; left: 0%; 
    width: 40px; height: 40px; 
    transform: translateX(-50%); 
    transition: left 0.1s linear;
    filter: drop-shadow(0 4px 5px rgba(0,0,0,0.3));
}
.loading-text { margin-top: 15px; font-weight: 900; font-size: 14px; letter-spacing: 2px; color: var(--accent); text-align: center; width: 100%; }
.rotating-cookie { 
    position: absolute; bottom: 30px; right: 30px; 
    font-size: 40px; animation: spinCookie 3s linear infinite; 
    filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
}
@keyframes spinCookie { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* DESIGN PROFISSIONAL TELA INICIAL */
#startScreen {
    position: fixed; inset: 0; background: var(--bg-gradient);
    z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s ease;
    overflow: hidden;
}

.bg-clouds {
    position: absolute;
    width: 200%;
    height: 100%;
    background: url('https://www.transparenttextures.com/patterns/clouds.png');
    opacity: 0.1;
    animation: moveClouds 60s linear infinite;
    pointer-events: none;
}
@keyframes moveClouds { from { transform: translateX(0); } to { transform: translateX(-50%); } }

.studio-brand {
    position: absolute;
    bottom: 25px;
    font-size: 12px;
    font-weight: 800;
    letter-spacing: 2px;
    opacity: 0.6;
    z-index: 5;
    color: var(--text-color);
    text-transform: uppercase;
}

.snow-container { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100vw; 
    height: 100vh; 
    pointer-events: none; 
    z-index: 1; 
}
.snowflake { position: absolute; color: white; font-size: 1.2em; top: -20px; animation: fall linear forwards; }
@keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

.start-bee-wrapper { 
    position: relative; 
    z-index: 2; 
    margin-bottom: 10px;
    filter: drop-shadow(0 20px 30px rgba(0,0,0,0.5));
}
.start-logo { animation: floatBee 4s infinite ease-in-out; }

.start-title { 
    font-size: clamp(34px, 14vw, 54px); 
    font-weight: 900; 
    color: var(--text-color); 
    margin-top: 10px; 
    letter-spacing: -1px;
    text-shadow: 0 10px 20px rgba(0,0,0,0.4); 
    z-index: 2;
    display: flex; 
    align-items: center; 
    justify-content: center;
}

.start-subtitle {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 40px;
    letter-spacing: 1px;
    text-transform: uppercase;
    opacity: 0.9;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    z-index: 2;
}

.btn-play-premium {
    width: 100%;
    padding: 20px !important;
    font-size: 20px !important;
    background: linear-gradient(135deg, var(--accent), #ffaa00) !important;
    color: var(--main-blue) !important;
    border-radius: 24px !important;
    box-shadow: 0 10px 25px rgba(255, 204, 0, 0.3), inset 0 -4px 0 rgba(0,0,0,0.2) !important;
    border: none !important;
    transition: 0.2s !important;
}
.btn-play-premium:active { transform: scale(0.96) translateY(4px) !important; box-shadow: 0 5px 10px rgba(255, 204, 0, 0.2) !important; }

.btn-secondary-glass {
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: white !important;
    box-shadow: none !important;
    font-size: 13px !important;
    font-weight: 700 !important;
    position: relative;
    border-radius: 18px !important;
}

/* BOT√ÉO CROM√ÅTICO PULSANTE */
.btn-chromatic-pulse {
    position: relative;
    overflow: visible !important;
    border: none !important;
    z-index: 10;
}

.btn-chromatic-pulse::before {
    content: "";
    position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    background: linear-gradient(90deg, #ff0000, #ffcc00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
    background-size: 400% 400%;
    border-radius: 22px;
    z-index: -1;
    animation: chromaticRotate 3s linear infinite, glowPulse 1.5s ease-in-out infinite;
}

@keyframes chromaticRotate { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
@keyframes glowPulse { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.05); opacity: 1; } }

.letter-i-wrapper { position: relative; display: inline-flex; justify-content: center; color: inherit; }
.tree-overlay {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -58%);
    font-size: 1.1em; pointer-events: none;
}

.pwa-btn-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    z-index: 10;
    margin-top: 5px;
}

.circular-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 22px;
    transition: 0.3s;
    position: relative;
    padding: 0;
}

.circular-btn:active { transform: scale(0.9); }

.aura-pulse::after {
    content: '';
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    border: 3px solid var(--accent);
    animation: auraEffect 1.5s infinite;
}

@keyframes auraEffect {
    0% { transform: scale(1); opacity: 1; border-color: var(--accent); }
    100% { transform: scale(1.5); opacity: 0; border-color: #00ff00; }
}

.game{ width:100%; max-width:420px; height: 100vh; padding:0; position: relative; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.5s; z-index: 10; display: none; overflow: hidden;}

.card { 
    background: var(--card); 
    backdrop-filter: var(--panel-blur);
    -webkit-backdrop-filter: var(--panel-blur);
    border-radius: 26px; 
    padding: 20px; 
    box-shadow: var(--shadow); 
    text-align: center; 
    position: relative; 
    margin-bottom: 12px; 
    border: 1px solid rgba(255,255,255,0.15); 
    transition: transform 0.1s, background 0.3s; 
}

#statsCard, .notif-card, #clickCard {
    margin-left: 14px;
    margin-right: 14px;
}

#statsCard { margin-top: 14px; }

.lvl-up-flash {
    animation: lvlUpFlash 1s ease-out forwards;
}
@keyframes lvlUpFlash {
    0% { transform: scale(1); box-shadow: var(--shadow); border-color: white; }
    50% { transform: scale(1.05); box-shadow: 0 0 30px var(--accent); border-color: var(--accent); }
    100% { transform: scale(1); box-shadow: var(--shadow); border-color: rgba(255,255,255,0.15); }
}

.notif-card { 
    height: 55px; 
    display: flex; 
    align-items: center; 
    padding: 0 15px; 
    overflow: hidden; 
    flex-shrink: 0; 
    gap: 10px;
    margin-bottom: 10px;
}
#notifContainer { flex: 1; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; color: inherit; }
.notif-static-icon { font-size: 20px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }

.save-icon { position: absolute; left: 18px; top: 22px; font-size: 18px; opacity: 0; transition: 0.3s; z-index: 10; }
.save-icon.visible { opacity: 1; animation: pulseSave 1s ease-out; }
@keyframes pulseSave { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

.settings-gear, .daily-mission-btn, .daily-reward-btn { position: absolute; top: 18px; cursor: pointer; transition: transform 0.3s ease; z-index: 10; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
.settings-gear { right: 18px; font-size: 24px; }
.daily-mission-btn { right: 55px; font-size: 24px; border-radius: 50%; padding: 2px; }

.mission-alert {
    animation: alertPulse 1.5s infinite;
    background: var(--xp-bar) !important;
}
@keyframes alertPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 rgba(76, 175, 80, 0); }
    50% { transform: scale(1.1); box-shadow: 0 0 15px var(--xp-bar); }
    100% { transform: scale(1); box-shadow: 0 0 0 rgba(76, 175, 80, 0); }
}

.daily-reward-btn { right: 92px; font-size: 24px; border-radius: 50%; padding: 2px; }

.level-container { margin-top: 12px; text-align: left; }
.level-info { display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; margin-bottom: 6px; color: inherit; }
.xp-bg { width: 100%; height: 12px; background: rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
.xp-fill { height: 100%; background: var(--xp-bar); width: 0%; transition: width 0.5s; }
.stats{ margin-top:8px; font-size:18px; font-weight: 800; color: var(--accent); }

/* CLICK CARD OCUPANDO O ESPA√áO DISPON√çVEL */
#clickCard {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-bottom: 80px; /* Espa√ßo para as abas inferiores */
}

.click-zone { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    width: 100%; 
    height: 100%; 
    position: relative; 
    touch-action: none; 
    border-radius: 20px; 
    overflow: hidden; 
    background-size: cover; 
    background-position: center; 
    transition: background 0.3s ease; 
}

.aura-wrapper { 
    position: relative; 
    width: 140px; 
    height: 140px; 
    display: flex; 
    justify-content: center; 
    align-items: center;
    overflow: visible; 
}

.bee-container { position: relative; z-index: 2; animation: floatBee 3s infinite ease-in-out; cursor: pointer; transition: transform 0.05s; }

.crown-overlay {
    position: absolute;
    top: -20px;
    font-size: 30px;
    z-index: 5;
    filter: drop-shadow(0 0 5px gold);
    display: none;
    pointer-events: none;
}

@keyframes floatBee { 0%, 100%{transform:translateY(0) rotate(0deg);} 50%{transform:translateY(-12px) rotate(3deg);} }
.target { height: 60px; width: 60px; border-radius: 20px; border: 3px dashed var(--accent); display: flex; align-items: center; justify-content: center; font-size: 24px; opacity: 0.7; background: rgba(255,255,255,0.1); backdrop-filter: blur(2px); transition: transform 0.1s; }

#active-boosts { position: absolute; top: 5px; width: 100%; display: flex; justify-content: center; gap: 8px; pointer-events: none; z-index: 5; flex-wrap: wrap; padding: 0 5px; }
.active-boost-timer { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.95); padding: 4px 8px; border-radius: 12px; border: 1.5px solid var(--accent); font-size: 10px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: var(--main-blue); }
.active-boost-passive { border-color: #ffffff; background: rgba(255,255,255,0.8); }

/* MAIN PANEL */
.main-panel { 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
    background: var(--card);
    backdrop-filter: var(--panel-blur);
    -webkit-backdrop-filter: var(--panel-blur);
    border-radius: 30px 30px 0 0; 
    margin: 0; 
    box-shadow: 0 -10px 30px rgba(0,0,0,0.4);
    border-top: 1px solid rgba(255,255,255,0.2);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px;
    z-index: 100;
}

.main-panel.is-full {
    height: 100vh;
}

.tabs-header { 
    display: flex; 
    background: rgba(0, 0, 0, 0.4); 
    border-top: 1px solid rgba(255,255,255,0.1); 
    flex-shrink: 0; 
    height: 70px;
    order: 2; 
}
.tab-btn { 
    flex: 1; 
    padding: 10px 2px; 
    border: none; 
    background: none; 
    font-weight: 800; 
    color: rgba(255,255,255,0.4); 
    cursor: pointer; 
    font-size: 18px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    gap: 2px;
    transition: 0.3s;
    position: relative;
}

.tab-btn span { font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.tab-btn.active { color: var(--accent); }
.tab-btn.active span { color: var(--text-color); }
.tab-btn.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 15%;
    right: 15%;
    height: 3px;
    background: var(--accent);
    border-radius: 0 0 5px 5px;
}

.tabs-content { 
    flex: 1; 
    overflow: hidden; 
    position: relative; 
    order: 1; 
    display: none; 
}

.main-panel.is-full .tabs-content {
    display: block;
}

.close-panel-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 35px;
    height: 35px;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-weight: 900;
}

.tab-pane { display: none; height: 100%; flex-direction: column; }
.tab-pane.active { display: flex; }

.scroll-area { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; touch-action: pan-y; }

.section-title { font-weight: 900; font-size: 14px; color: var(--accent); margin-bottom: 12px; margin-top: 10px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
.section-title::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }

.fixed-nav-header { flex-shrink: 0; background: rgba(0,0,0,0.1); padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.shop-nav, .filter-bar { display: flex; gap: 8px; }
.sub-tab-btn, .filter-btn { flex: 1; padding: 10px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); font-size: 10px; font-weight: 800; cursor: pointer; transition: 0.2s; color: inherit; }
.sub-tab-btn.active, .filter-btn.active { background: var(--accent); color: var(--main-blue); }

/* ESTILOS LOJA REFORMULADA */
.shop-card-item {
    background: rgba(255,255,255,0.05);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: 0.2s;
}

.shop-card-icon {
    width: 60px;
    height: 60px;
    background: rgba(0,0,0,0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    flex-shrink: 0;
}

.shop-card-info {
    flex: 1;
    text-align: left;
}

.shop-card-title {
    font-weight: 900;
    font-size: 14px;
    color: var(--accent);
    margin-bottom: 2px;
}

.shop-card-desc {
    font-size: 10px;
    opacity: 0.6;
    line-height: 1.3;
}

.shop-card-grid-btns {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 10px;
}

.btn-buy-tiny {
    padding: 8px 4px;
    font-size: 10px;
    height: auto;
    border-radius: 12px;
    margin-top: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.btn-buy-tiny span:last-child {
    font-weight: 900;
    color: var(--main-blue);
    opacity: 0.8;
}

.buy-btn-small { 
    padding: 12px 8px; 
    font-size: 11px; 
    min-height: 90px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    background: rgba(255,255,255,0.05); 
    border-radius: 18px; 
    border: 1px solid rgba(255,255,255,0.1);
    color: inherit;
}
.buy-btn-small:not(:disabled):active { border-color: var(--accent); transform: scale(0.98); }

button{ width:100%; padding:15px; margin-top:8px; border:none; border-radius:18px; font-size:14px; font-weight:800; background:var(--accent); color: var(--main-blue); box-shadow:0 4px 0 rgba(0,0,0,0.3); cursor: pointer; transition: 0.1s; touch-action: manipulation; }
button:active{ transform:translateY(2px); box-shadow:0 2px 0 rgba(0,0,0,0.3); }
button:disabled { background:rgba(0,0,0,0.2) !important; color:rgba(255,255,255,0.2) !important; box-shadow: none !important; opacity: 0.5; border: 1px solid rgba(255,255,255,0.05); }

.config-group-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 15px;
    margin-bottom: 15px;
}
.config-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; text-align: left; }
.config-row:last-child { margin-bottom: 0; }
.config-label { font-weight: 800; font-size: 13px; color: inherit; display: flex; justify-content: space-between; align-items: center; }
.config-label span:last-child { color: var(--accent); font-size: 12px; }

input[type="color"] { 
    border: 2px solid rgba(255,255,255,0.2); 
    width: 50px; height: 30px; 
    background: none; cursor: pointer; 
    border-radius: 8px;
    padding: 0;
}

input[type=range] { 
    -webkit-appearance: none;
    width: 100%;
    background: rgba(0,0,0,0.15);
    height: 6px;
    border-radius: 5px;
    outline: none;
    border: 1px solid rgba(255,255,255,0.1);
}
input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: var(--accent);
    cursor: pointer;
    border-radius: 50%;
    border: 2px solid var(--dark);
}

.modal{ position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter: blur(12px); display:none; justify-content:center; align-items:center; z-index:10001; padding: 20px; transition: background 0.3s; }
.modal-box{ background: var(--card); backdrop-filter: var(--panel-blur); width:100%; max-width:380px; max-height: 85svh; border-radius:35px; overflow:hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.8); border: 2px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; transition: background 0.3s; }
.modal-header{ padding:20px; background: var(--accent); font-weight:900; display:flex; justify-content:space-between; color: var(--main-blue); font-size: 18px; flex-shrink: 0; }

.modal-content-scroll { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; color: inherit; touch-action: pan-y; }
.modal-footer { padding: 0 20px 20px 20px; background: transparent; flex-shrink: 0; }

.game-card {
    display: flex;
    flex-direction: column;
    background: rgba(255,255,255,0.07);
    border-radius: 22px;
    margin-bottom: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    overflow: hidden;
    transition: 0.3s;
}
.game-card:hover { background: rgba(255,255,255,0.12); }
.game-card-header {
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}
.game-icon {
    width: 60px; height: 60px;
    background: var(--card);
    border-radius: 15px;
    display: flex; align-items: center; justify-content: center;
    font-size: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.game-meta { flex: 1; text-align: left; }
.game-title { font-weight: 900; font-size: 16px; color: inherit; }
.game-record { font-size: 11px; color: var(--accent); font-weight: 800; margin-top: 3px; }
.game-play-area {
    padding: 0 15px 15px 15px;
}

#minigameOverlay {
    position: fixed; inset: 0; 
    background: var(--bg-gradient);
    z-index: 20000;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(20px);
}
#snakeCanvas, #flightCanvas, #rainCanvas, #defenderCanvas { 
    background: #000; 
    border: 3px solid rgba(255,255,255,0.2); 
    border-radius: 20px; 
    box-shadow: 0 0 40px rgba(0,0,0,0.5);
    max-width: 95vw; 
    aspect-ratio: 1/1;
    display: none; 
}
.mg-header { 
    width: 100%; max-width: 400px; padding: 20px; 
    display: flex; justify-content: space-between; align-items: center; 
}
.mg-stats-panel { text-align: left; display: flex; align-items: center; gap: 15px; }
.mg-score-box { display: flex; flex-direction: column; }
.mg-label { font-size: 10px; text-transform: uppercase; opacity: 0.7; font-weight: 800; }
.mg-val { font-size: 24px; font-weight: 900; color: var(--accent); display: block; }

#mgLiveBoosts {
    display: flex;
    gap: 8px;
    background: rgba(255,255,255,0.1);
    padding: 5px 10px;
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    height: 40px;
    align-items: center;
    min-width: 40px;
}
.mg-live-boost-icon { font-size: 20px; animation: popBoost 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popBoost { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.mg-controls { margin-top: 20px; display: grid; grid-template-areas: ". up ." "left down right"; gap: 15px; }
.dpad-btn { 
    width: 70px; height: 70px; 
    background: rgba(255,255,255,0.1); 
    border-radius: 20px; 
    display: flex; align-items: center; justify-content: center; 
    font-size: 28px; color: white; 
    border: 1px solid rgba(255,255,255,0.2); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.dpad-btn:active { background: var(--accent); color: var(--main-blue); transform: scale(0.9); }

.fire-btn {
    width: 80px; height: 80px;
    background: #ff4757;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: 3px solid rgba(255,255,255,0.3);
    box-shadow: 0 6px 0 #c0392b;
}
.fire-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #c0392b; background: #ff6b81; }

#mgCountdown { position: absolute; font-size: 120px; color: var(--accent); font-weight: 900; text-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 20005; display: none; }
#mgResultScreen {
    position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 20110;
    display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 30px;
}

.changelog-block { margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
.changelog-section-title { font-weight: 900; font-size: 15px; margin-bottom: 12px; color: var(--accent); border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 2px; }
.changelog-item { display: flex; gap: 10px; margin-bottom: 8px; font-size: 13px; line-height: 1.4; color: inherit; opacity: 0.8; align-items: flex-start; }
.changelog-icon { font-size: 14px; flex-shrink: 0; margin-top: 1px; }

.popup { position: absolute; background: transparent; width: 100%; font-weight: 800; font-size: 11px; color: inherit; pointer-events: none; text-align: center; display: flex; align-items: center; justify-content: center; padding: 0 10px; opacity: 0; }
@keyframes slideInNotif { 0% { transform: translateY(40px); opacity: 0; } 10% { transform: translateY(0); opacity: 1; } 90% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-40px); opacity: 0; } }

.version-tag { color: inherit; opacity: 0.4; margin-top: 10px; font-weight: bold; font-size: 10px; text-align: center; width: 100%; letter-spacing: 1px; }

.mission-card { display: flex; align-items: center; padding: 14px; border-radius: 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); text-align: left; gap: 14px; margin-bottom: 10px; transition: 0.3s; position: relative; overflow: hidden; }
.mission-card.completed { border-color: var(--xp-bar); background: rgba(76, 175, 80, 0.1); }
.mission-card.collected { border-color: rgba(255,255,255,0.2); opacity: 0.6; }
.mission-card.completed:not(.collected)::after { content: 'CONCLU√çDO'; position: absolute; top: 8px; right: 8px; font-size: 8px; font-weight: 900; color: var(--xp-bar); background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 10px; }
.mission-card.collected::after { content: 'COLETADO'; position: absolute; top: 8px; right: 8px; font-size: 8px; font-weight: 900; color: inherit; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 10px; }

.mission-reroll-btn { 
    position: absolute; bottom: 8px; right: 8px; 
    width: 32px; height: 32px; 
    background: rgba(255,255,255,0.1); 
    border: 1px solid rgba(255,255,255,0.2); 
    border-radius: 10px; 
    display: flex; align-items: center; justify-content: center; 
    font-size: 14px; cursor: pointer; transition: 0.2s; 
    z-index: 5;
}
.mission-reroll-btn:active { transform: scale(0.9) rotate(45deg); background: var(--accent); color: var(--main-blue); }

.mission-progress-bar { width: 100%; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; margin-top: 8px; overflow: hidden; }
.mission-progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
.mission-card.completed .mission-progress-fill { background: var(--xp-bar); }
.mission-reward-tag { display: inline-block; padding: 3px 8px; background: rgba(255, 204, 0, 0.2); color: var(--accent); font-size: 9px; font-weight: 900; border-radius: 6px; margin-top: 5px; }

.ach-card { display: flex; align-items: center; padding: 14px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); text-align: left; gap: 14px; margin-bottom: 10px; transition: 0.3s; }
.ach-card.locked { opacity: 0.4; filter: grayscale(1); background: rgba(0,0,0,0.2); }
.ach-card.unlocked.rare { border-color: var(--rare); background: rgba(9, 132, 227, 0.15); }
.ach-card.unlocked.epic { border-color: var(--epic); background: rgba(162, 155, 254, 0.15); }

.floating-num-container {
    position: fixed;
    pointer-events: none;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: floatUp 0.8s ease-out forwards;
}

.floating-num {
    font-weight: 900;
    font-size: 24px;
    color: var(--accent);
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.super-critical-label {
    font-weight: 900;
    font-size: 14px;
    color: #ff4757;
    margin-top: -2px;
    text-shadow: 0 0 10px rgba(255,71,87,0.5);
}

@keyframes floatUp {
    0% { transform: translateY(0) scale(0.5); opacity: 0; }
    20% { opacity: 1; transform: translateY(-20px) scale(1.2); }
    100% { transform: translateY(-80px) scale(1); opacity: 0; }
}

.honey-particle {
    position: fixed;
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    pointer-events: none;
    z-index: 9999;
    animation: explode 0.5s ease-out forwards;
}
@keyframes explode {
    to { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
}

#downloadOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100000;
    display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center;
}
.dl-step { margin-bottom: 20px; display: flex; align-items: center; gap: 15px; text-align: left; width: 100%; max-width: 300px; }
.dl-icon { width: 45px; height: 45px; background: var(--accent); color: var(--main-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; flex-shrink: 0; }

.daily-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
.day-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 5px; text-align: center; position: relative; }
.day-card.active { border-color: var(--accent); background: rgba(255,204,0,0.1); box-shadow: 0 0 10px rgba(255,204,0,0.3); }
.day-card.claimed { opacity: 0.5; filter: grayscale(1); border-color: var(--xp-bar); }
.day-num { font-size: 9px; font-weight: 900; opacity: 0.6; display: block; margin-bottom: 5px; }
.day-icon { font-size: 20px; display: block; }
.day-reward-val { font-size: 9px; font-weight: 800; color: var(--accent); }

.hangar-box {
    background: rgba(255,255,255,0.05);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    padding: 15px;
    margin-bottom: 12px;
    position: relative;
    overflow: hidden;
}
.hangar-title {
    font-weight: 900;
    font-size: 11px;
    color: var(--accent);
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
}
.hangar-lock {
    height: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.expedition-timer { font-size: 22px; font-weight: 900; color: var(--accent); display: block; margin: 10px 0; }
.expedition-slider-box { margin-top: 15px; text-align: left; }
.expedition-slider-box label { font-size: 12px; font-weight: 800; opacity: 0.7; }

.biome-selector { display: flex; gap: 8px; margin-top: 15px; }
.biome-btn { 
    flex: 1; padding: 10px 5px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1); 
    background: rgba(255,255,255,0.05); color: inherit; font-size: 10px; font-weight: 800; 
    cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px;
}
.biome-btn.selected { border-color: var(--accent); background: rgba(255,204,0,0.15); transform: translateY(-3px); }
.biome-icon { font-size: 20px; }

.exp-event-btn {
    width: 100%; padding: 12px; border-radius: 14px; margin-top: 10px; 
    font-weight: 900; font-size: 12px; text-transform: uppercase;
    animation: btnGlow 1s infinite alternate;
}
@keyframes btnGlow { from { box-shadow: 0 0 5px rgba(255,255,255,0.2); } to { box-shadow: 0 0 15px var(--accent); } }

.exp-event-area { 
    background: rgba(0,0,0,0.3); border: 1.5px dashed var(--accent); 
    border-radius: 18px; padding: 12px; margin-top: 12px; display: none;
}

.exp-result-inline {
    padding: 15px; background: rgba(76, 175, 80, 0.1); border: 2px solid var(--xp-bar); border-radius: 18px; display: none;
}

.exp-synergy-tag {
    font-size: 9px;
    background: var(--accent);
    color: var(--main-blue);
    padding: 2px 6px;
    border-radius: 5px;
    font-weight: 900;
    margin-top: 5px;
}

.hive-stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.08);
}
.hive-stat-label { font-size: 13px; font-weight: 700; color: inherit; display: flex; align-items: center; gap: 8px; }
.hive-stat-val { font-size: 14px; font-weight: 900; color: var(--accent); }
.hive-bonus-badge {
    padding: 2px 8px;
    background: var(--xp-bar);
    color: white;
    font-size: 10px;
    border-radius: 6px;
    font-weight: 900;
}

/* TREE CSS */
.talent-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 18px;
    padding: 12px;
    margin-bottom: 12px;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 12px;
}
.talent-icon {
    width: 45px; height: 45px;
    background: var(--card);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
}
.talent-info { flex: 1; }
.talent-name { font-weight: 900; font-size: 13px; color: inherit; }
.talent-desc { font-size: 10px; opacity: 0.6; }
.talent-points { font-size: 11px; font-weight: 800; color: var(--accent); }
.talent-btn {
    width: 36px; height: 36px; padding: 0; margin: 0;
    border-radius: 50%; font-size: 18px;
}

/* MODULAR HIVE CSS */
.modular-hive-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin-bottom: 20px;
    line-height: 0;
}
.hive-module {
    width: 100%;
    max-width: 250px;
    display: block;
    margin: 0;
    padding: 0;
    margin-top: -1px;
    transition: all 0.5s ease-in-out;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
}
.hive-module-hidden {
    display: none;
}

/* VELHO DUDU CSS REFORMULADO */
.dudu-shop-banner {
    background: linear-gradient(135deg, rgba(255, 234, 0, 0.2), rgba(255, 170, 0, 0.1));
    border: 2px solid var(--accent);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.dudu-shop-banner::before {
    content: 'MERCADO';
    position: absolute;
    top: -10px; left: -10px;
    font-size: 40px; font-weight: 900;
    opacity: 0.05; transform: rotate(-15deg);
}

.dudu-bubble {
    background: white;
    color: #333;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 800;
    position: relative;
    margin-bottom: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.dudu-bubble::after {
    content: '';
    position: absolute;
    bottom: -8px; left: 50%;
    transform: translateX(-50%);
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid white;
}

.market-stats-row {
    width: 100%;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 15px;
}

.market-stat-pill {
    flex: 1;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 15px;
    text-align: center;
}

.market-stat-pill span:first-child {
    display: block;
    font-size: 9px;
    opacity: 0.6;
    text-transform: uppercase;
    font-weight: 900;
}

.market-stat-pill span:last-child {
    font-size: 14px;
    font-weight: 900;
    color: var(--crown-gold);
}

/* SELETOR DE QUANTIDADE MERCADO */
.market-qty-control {
    width: 100%;
    background: rgba(0,0,0,0.2);
    padding: 15px;
    border-radius: 20px;
    margin-bottom: 12px;
}

.market-qty-label {
    display: block;
    font-size: 11px;
    font-weight: 900;
    margin-bottom: 10px;
    text-align: left;
    opacity: 0.7;
}

.market-qty-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}

.market-qty-input {
    flex: 1;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 12px;
    color: white;
    padding: 10px;
    font-size: 16px;
    font-weight: 900;
    text-align: center;
    outline: none;
}

.market-qty-btns {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 5px;
}

.qty-btn {
    padding: 8px 0;
    font-size: 10px;
    border-radius: 10px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    box-shadow: none;
    margin-top: 0;
}

.qty-btn.active {
    background: var(--accent);
    color: var(--main-blue);
    font-weight: 900;
    border-color: var(--accent);
}

/* ESTILO LABORAT√ìRIO MELHORADO */
.lab-machine-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 26px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.lab-icon-big {
    font-size: 60px;
    margin-bottom: 15px;
    display: block;
    transition: transform 0.5s;
}
.lab-working .lab-icon-big {
    animation: machinePulse 1s infinite alternate;
}
@keyframes machinePulse {
    from { transform: scale(1) rotate(0deg); }
    to { transform: scale(1.1) rotate(5deg); }
}

.lab-stat-box {
    display: flex;
    justify-content: space-around;
    margin-bottom: 20px;
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 20px;
}
.lab-stat-item {
    display: flex;
    flex-direction: column;
}
.lab-stat-label {
    font-size: 10px;
    font-weight: 800;
    opacity: 0.6;
    text-transform: uppercase;
}
.lab-stat-value {
    font-size: 18px;
    font-weight: 900;
    color: var(--accent);
}

/* PROGRESS BAR LABORAT√ìRIO */
.lab-progress-container {
    width: 100%;
    height: 25px;
    background: rgba(0,0,0,0.3);
    border-radius: 15px;
    margin: 15px 0;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    display: none;
    position: relative;
}
.lab-progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #4caf50, #8bc34a);
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
    transition: width 0.1s linear;
}
.lab-progress-text {
    position: absolute;
    width: 100%;
    text-align: center;
    font-size: 10px;
    font-weight: 900;
    line-height: 25px;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

/* SLOTS LABORAT√ìRIO */
.lab-slots-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-top: 20px;
}

.lab-slot {
    aspect-ratio: 1/1;
    background: rgba(255,255,255,0.05);
    border: 1.5px dashed rgba(255,255,255,0.2);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: 0.2s;
    cursor: pointer;
}

.lab-slot.has-bottles {
    background: rgba(255, 234, 0, 0.1);
    border: 1.5px solid var(--accent);
    border-style: solid;
}

.lab-slot.has-bottles:active {
    transform: scale(0.95);
}

.slot-icon {
    font-size: 20px;
    opacity: 0.4;
}

.lab-slot.has-bottles .slot-icon {
    opacity: 1;
    filter: drop-shadow(0 0 5px var(--accent));
}

.slot-count {
    font-size: 9px;
    font-weight: 900;
    color: white;
    margin-top: 4px;
}

.slot-collect-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--xp-bar);
    color: white;
    font-size: 8px;
    font-weight: 900;
    padding: 2px 4px;
    border-radius: 5px;
    display: none;
}

.lab-slot.has-bottles .slot-collect-badge {
    display: block;
}

/* ENVASAMENTO EM MASSA */
.lab-batch-selector {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    background: rgba(0,0,0,0.2);
    padding: 5px;
    border-radius: 15px;
}
.batch-btn {
    flex: 1;
    padding: 8px 0;
    border-radius: 10px;
    font-size: 11px;
    background: transparent;
    color: white;
    border: 1px solid transparent;
    box-shadow: none;
    margin-top: 0;
}
.batch-btn.active {
    background: var(--accent);
    color: var(--main-blue);
    font-weight: 900;
}
</style>
</head>

<body oncontextmenu="return false;">

<div id="loadingScreen">
    <div class="loading-container">
        <img id="loadingBeeImg" src="NoelBee.png" alt="Bee" class="loading-bee">
        <div class="loading-bar-bg">
            <div id="loadingBarFill" class="loading-bar-fill"></div>
        </div>
        <div class="loading-text" id="loadingTextMsg">PREPARANDO COLMEIA...</div>
    </div>
    <div class="rotating-cookie">üç™</div>
</div>

<div id="startScreen">
    <div class="bg-clouds"></div>
    <div class="snow-container" id="snowContainer"></div>
    <div class="start-bee-wrapper">
        <div class="start-logo">
            <img src="NoelBee.png" alt="NoelBee Logo" class="bee-img-large">
        </div>
    </div>
    <div class="start-title">
        BEEK<span class="letter-i-wrapper">I<span class="tree-overlay">üéÑ</span></span>ND
    </div>
    <div class="start-subtitle">Be kind to bees and earn honey.</div>
    
    <div style="display: flex; flex-direction: column; gap: 15px; width: 280px; z-index: 10;">
        <button class="btn-play-premium" onclick="enterGame()">JOGAR AGORA</button>
        <button id="btnChangelog" class="btn-secondary-glass" onclick="openChangelog()">O QUE MUDOU?</button>
        
        <div class="pwa-btn-container">
            <button class="btn-secondary-glass" style="flex: 1; padding: 12px !important;" onclick="openModal('settingsModal')">
                AJUSTES ‚öôÔ∏è
            </button>
            <button id="pwaMainActionBtn" class="circular-btn" onclick="handlePwaClick()">
                <span id="pwaIcon">üì•</span>
            </button>
        </div>
    </div>

    <div class="studio-brand">Funüç™Cook Studio</div>
</div>

<div class="game" id="gameUI">
  <div class="snow-container" id="gameSnowContainer"></div>
  
  <div class="card" id="statsCard">
    <div id="saveIndicator" class="save-icon">üíæ</div>
    <div class="daily-reward-btn" onclick="openModal('dailyRewardModal')">üéÅ</div>
    <div id="btnMissionAlert" class="daily-mission-btn" onclick="openModal('missionsModal')">üìù</div>
    <div class="settings-gear" onclick="openModal('settingsModal')">‚öôÔ∏è</div>

    <div id="gameHeaderTitle" style="font-size: 18px; font-weight: 900; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 8px;">
        BeeKind <img id="miniBeeHeader" src="NoelBee.png" alt="Bee" style="width: 20px; height: 20px;">
    </div>
    <div class="stats">
        üçØ <span id="honey">0</span> | üëë <span id="crowns" style="color: var(--crown-gold);">0</span>
    </div>
    <div style="font-size: 12px; font-weight: 800; opacity: 0.8; margin-top: 5px;">
        ‚ö° <span id="mps">0</span>/s
    </div>
    <div class="level-container">
      <div class="level-info"><span>N√≠vel <span id="lvlDisplay">1</span></span><span id="xpDisplay">0 / 1.0K</span></div>
      <div class="xp-bg"><div class="xp-fill" id="xpFill"></div></div>
    </div>
  </div>

  <div class="card notif-card">
      <div class="notif-static-icon">üì¢</div>
      <div id="notifContainer"></div>
  </div>

  <div class="card" id="clickCard">
    <div id="active-boosts"></div>
    <div class="click-zone" id="clickZone">
      <div class="target" id="leftTarget">üéØ</div>
      <div class="aura-wrapper">
        <div class="bee-container" id="beeContainer">
            <div class="crown-overlay" id="beeCrown">üëë</div>
            <img id="mainBeeSprite" src="NoelBee.png" alt="Bee character" class="bee-img">
        </div>
      </div>
      <div class="target" id="rightTarget">üéØ</div>
    </div>
  </div>

  <div class="main-panel" id="mainPanel">
      <button class="close-panel-btn" id="btnClosePanel" style="display:none;" onclick="togglePanel(false)">‚úñ</button>
      
      <div class="tabs-header">
          <button class="tab-btn" onclick="openTab('talents', this)">üå≥<span>Talentos</span></button>
          <button class="tab-btn" onclick="openTab('shop', this)">üõí<span>Loja</span></button>
          <button class="tab-btn" onclick="openTab('lab', this)">üß™<span>Laborat√≥rio</span></button>
          <button class="tab-btn" onclick="openTab('expedition-tab', this)">üß≠<span>Expedi√ß√£o</span></button>
          <button class="tab-btn" onclick="openTab('hive-stats', this)">üè†<span>Colmeia</span></button>
          <button id="btnTabGames" class="tab-btn" onclick="openTab('events', this)">üéÆ<span>Jogos</span></button>
          <button class="tab-btn" onclick="openTab('achievements', this)">üéñÔ∏è<span>Conquistas</span></button>
      </div>
      
      <div class="tabs-content" id="mainScrollArea">
          <div id="talents" class="tab-pane">
              <div class="scroll-area">
                <div class="section-title">√ÅRVORE DE TALENTOS REAIS</div>
                <div id="talentPointsDisplay" style="background: var(--accent); color: var(--main-blue); padding: 10px; border-radius: 12px; font-weight: 900; font-size: 14px; margin-bottom: 20px; text-align: center;">PONTOS DISPON√çVEIS: 0</div>
                
                <div class="section-title">OPER√ÅRIO (CLIQUES) üêù</div>
                <div id="tree_clicks"></div>

                <div class="section-title">ARQUITETO (AUTOMA√á√ÉO) üè†</div>
                <div id="tree_auto"></div>

                <div class="section-title">ALQUIMISTA (SORTE) üß™</div>
                <div id="tree_luck"></div>
                
                <button onclick="resetTalents()" style="background: #e74c3c; color: white; margin-top: 30px; font-size: 12px; height: auto; padding: 10px;">RESETAR TALENTOS (10% Mel Total)</button>
              </div>
          </div>

          <div id="shop" class="tab-pane">
              <div class="fixed-nav-header">
                <div class="shop-nav">
                    <button class="sub-tab-btn active" onclick="openSubShop('boosts', this)">MERCADO & BOOSTS</button>
                    <button class="sub-tab-btn" onclick="openSubShop('cosmetics', this)">VISUAIS</button>
                </div>
              </div>
              <div class="scroll-area">
                <div id="shop_boosts" class="sub-shop-pane">
                  
                  <div class="dudu-shop-banner">
                        <div class="dudu-bubble" id="duduSpeech">Quantas garrafas quer me vender hoje?</div>
                        <div style="font-size: 50px; margin-bottom: 10px;">üë¥</div>
                        
                        <div class="market-stats-row">
                            <div class="market-stat-pill">
                                <span>STOCK TOTAL</span>
                                <span id="shopBottlesCount">0</span>
                            </div>
                            <div class="market-stat-pill">
                                <span>TOTAL EM üëë</span>
                                <span id="shopCrownValueTotal">0</span>
                            </div>
                        </div>

                        <div class="market-qty-control">
                            <span class="market-qty-label">QUANTIDADE PARA VENDA:</span>
                            <div class="market-qty-input-group">
                                <input type="number" id="marketSellQtyInput" class="market-qty-input" value="1" min="1" oninput="updateMarketVendaUI()">
                            </div>
                            <div class="market-qty-btns">
                                <button class="qty-btn" onclick="setMarketSellQty(1)">1</button>
                                <button class="qty-btn" onclick="setMarketSellQty(10)">10</button>
                                <button class="qty-btn" onclick="setMarketSellQty(100)">100</button>
                                <button class="qty-btn" id="marketQtyAll" onclick="setMarketSellQty('all')">TUDO</button>
                            </div>
                        </div>
                        
                        <div style="width: 100%; text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 20px; border: 1.5px solid var(--crown-gold); margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 10px; opacity: 0.7; display: block;">RECEBER√Å:</span>
                                    <span style="font-size: 18px; font-weight: 900; color: var(--crown-gold);" id="marketSellPreviewValue">0 üëë</span>
                                </div>
                                <button onclick="sellBottlesDynamic()" id="btnSellBottles" style="width: auto; margin-top: 0; padding: 12px 25px; background: var(--crown-gold); color: var(--main-blue); border-radius: 12px; font-size: 12px;">VENDER AGORA</button>
                            </div>
                        </div>

                        <p style="font-size: 10px; opacity: 0.6;">Taxa fixa: 1 üç∂ = 10 üëë</p>
                    </div>

                  <div class="section-title">INFUS√ïES REAIS üß™</div>
                  <div id="boosts_container_new">
                      </div>

                </div>

                <div id="shop_cosmetics" class="sub-shop-pane" style="display:none;">
                  <div class="section-title">üëî GUARDA-ROUPA</div>
                  <div class="shop-grid">
                    <button class="buy-btn-small" id="btn_cos_Bee" onclick="handleCosmetic('Bee')">
                      <img src="Bee.png" class="skin-preview">
                      <b>Comum</b>
                    </button>
                    <button class="buy-btn-small" id="btn_cos_NoelBee" onclick="handleCosmetic('NoelBee')">
                      <img src="NoelBee.png" class="skin-preview">
                      <b>Noel (+10%)</b>
                    </button>
                    <button class="buy-btn-small" id="btn_cos_SkullBee" onclick="handleCosmetic('SkullBee')">
                      <img src="SkullBee.png" class="skin-preview">
                      <b>Skull (+5% Crit)</b>
                    </button>
                    <button class="buy-btn-small" id="btn_cos_FairyBee" onclick="handleCosmetic('FairyBee')">
                      <img src="FairyBee.png" class="skin-preview">
                      <b>Fairy (+6% Luck)</b>
                    </button>
                  </div>

                  <div class="section-title">üñºÔ∏è CEN√ÅRIOS</div>
                  <div class="shop-grid">
                    <button class="buy-btn-small" id="btn_bg_BgPadrao" onclick="handleBackground('BgPadrao')">
                      <div style="width:40px;height:40px;background:url('BgPadrao.gif');background-size:cover;margin-bottom:5px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)"></div>
                      <b>Padr√£o</b>
                    </button>
                    <button class="buy-btn-small" id="btn_bg_BgCristmas" onclick="handleBackground('BgCristmas')">
                      <div style="width:40px;height:40px;background:url('BgCristmas.gif');background-size:cover;margin-bottom:5px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)"></div>
                      <b>Natal üéÑ</b>
                    </button>
                    <button class="buy-btn-small" id="btn_bg_BgRaining" onclick="handleBackground('BgRaining')">
                      <div style="width:40px;height:40px;background:url('BgRaining.gif');background-size:cover;margin-bottom:5px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)"></div>
                      <b>Chuva üåßÔ∏è</b>
                    </button>
                    <button class="buy-btn-small" id="btn_bg_BgNight" onclick="handleBackground('BgNight')">
                      <div style="width:40px;height:40px;background:url('BgNight.gif');background-size:cover;margin-bottom:5px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)"></div>
                      <b>Noite üåô</b>
                    </button>
                    <button class="buy-btn-small" id="btn_bg_BgLake" onclick="handleBackground('BgLake')">
                      <div style="width:40px;height:40px;background:url('BgLake.gif');background-size:cover;margin-bottom:5px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)"></div>
                      <b>Lago üåä</b>
                    </button>
                  </div>
                </div>
              </div>
          </div>

          <div id="lab" class="tab-pane">
              <div class="scroll-area">
                <div class="section-title">LABORAT√ìRIO DE ENGARRAFAMENTO üß™</div>
                
                <div class="lab-machine-card" id="labMachine">
                    <span class="lab-icon-big" id="labMachineIcon">üç∂</span>
                    <h2 style="margin: 0; color: var(--accent);">M√ÅQUINA DE ENVASAMENTO</h2>
                    
                    <div class="lab-stat-box">
                        <div class="lab-stat-item">
                            <span class="lab-stat-label">Mel Dispon√≠vel</span>
                            <span class="lab-stat-value" id="labHoneyValue">0</span>
                        </div>
                        <div class="lab-stat-item">
                            <span class="lab-stat-label">Em estoque</span>
                            <span class="lab-stat-value" id="labBottlesValue">0</span>
                        </div>
                    </div>

                    <div class="lab-progress-container" id="labProgressContainer">
                        <div class="lab-progress-text" id="labProgressText">PROCESSANDO... 45s</div>
                        <div class="lab-progress-fill" id="labProgressFill"></div>
                    </div>

                    <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 20px; margin-bottom: 20px;">
                        <div style="font-size: 11px; font-weight: 800; margin-bottom: 10px; text-align: left;">QUANTIDADE DE ENVASAMENTO:</div>
                        
                        <div class="lab-batch-selector">
                            <button class="batch-btn active" id="batch1" onclick="setBatch(1)">1</button>
                            <button class="batch-btn" id="batch10" onclick="setBatch(10)">10</button>
                            <button class="batch-btn" id="batch100" onclick="setBatch(100)">100</button>
                            <button class="batch-btn" id="batchAll" onclick="setBatch('all')">TUDO</button>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <div style="text-align: left;">
                                <span style="font-size: 14px; font-weight: 900; display: block;" id="batchCostLabel">750K üçØ</span>
                                <small style="font-size: 9px; opacity: 0.7;">Custo Total</small>
                            </div>
                            <button onclick="bottleHoney()" id="btnBottle" style="width: auto; margin-top: 0; padding: 10px 25px; font-size: 12px; font-weight: 900;">INICIAR PRODU√á√ÉO</button>
                        </div>
                    </div>

                    <div class="section-title">SLOTS DE ARMAZENAMENTO</div>
                    <p style="font-size: 10px; opacity: 0.6; margin-bottom: 10px; text-align: left;">A m√°quina produz garrafas para os slots abaixo. Colete-as para levar ao Mercado.</p>
                    
                    <div id="labSlotsGrid" class="lab-slots-grid">
                        </div>
                </div>
              </div>
          </div>

          <div id="expedition-tab" class="tab-pane">
              <div class="scroll-area" id="expeditionScroll">
                  <div class="section-title">CENTRO DE HANGAR (EXPEDI√á√ïES)</div>
                  <div id="synergyDisplay" style="margin-bottom: 10px;"></div>
                  <div id="hangarList"></div>
              </div>
          </div>

          <div id="hive-stats" class="tab-pane">
              <div class="scroll-area" id="hiveStatsContent">
              </div>
          </div>

          <div id="events" class="tab-pane">
              <div class="scroll-area">
                  <div class="section-title">CENTRAL DE JOGOS</div>

                  <div class="game-card">
                    <div class="game-card-header">
                        <div class="game-icon">üî´</div>
                        <div class="game-meta">
                            <div class="game-title">Hive Defender (v1.11)</div>
                            <div class="game-record">N√çVEL ATUAL: <span id="defenderLevelDisplay">1</span></div>
                        </div>
                    </div>
                    <div class="game-play-area">
                        <button onclick="prepareMinigame('defender')">INICIAR PARTIDA</button>
                    </div>
                </div>
                  
                  <div class="game-card">
                      <div class="game-card-header">
                          <div class="game-icon">üçØ</div>
                          <div class="game-meta">
                              <div class="game-title">Honey Rain (v4.6)</div>
                              <div class="game-record">RECORD: <span id="rainRecordDisplay">0</span></div>
                          </div>
                      </div>
                      <div class="game-play-area">
                          <button onclick="prepareMinigame('rain')">INICIAR PARTIDA</button>
                      </div>
                  </div>

                  <div class="game-card">
                      <div class="game-card-header">
                          <div class="game-icon">üêç</div>
                          <div class="game-meta">
                              <div class="game-title">Bee-Line (Snake)</div>
                              <div class="game-record">RECORD: <span id="snakeRecordDisplay">0</span></div>
                          </div>
                      </div>
                      <div class="game-play-area">
                          <button onclick="prepareMinigame('snake')">INICIAR PARTIDA</button>
                      </div>
                  </div>

                  <div class="game-card">
                      <div class="game-card-header">
                          <div class="game-icon">üå∏</div>
                          <div class="game-meta">
                              <div class="game-title">Bee Flight</div>
                              <div class="game-record">RECORD: <span id="flightRecordDisplay">0</span></div>
                          </div>
                      </div>
                      <div class="game-play-area">
                          <button onclick="prepareMinigame('flight')">INICIAR PARTIDA</button>
                      </div>
                  </div>
              </div>
          </div>

          <div id="achievements" class="tab-pane">
              <div class="fixed-nav-header">
                  <div class="filter-bar">
                      <button class="filter-btn active" onclick="setAchFilter('all', this)">TODAS</button>
                      <button class="filter-btn" onclick="setAchFilter('common', this)">COMUNS</button>
                      <button class="filter-btn" onclick="setAchFilter('rare', this)">RARAS</button>
                      <button class="filter-btn" onclick="setAchFilter('epic', this)">√âPICAS</button>
                  </div>
              </div>
              <div class="scroll-area">
                  <div id="achList"></div>
              </div>
          </div>
      </div>
  </div>
</div>

<div id="downloadOverlay">
    <h2 style="color: var(--accent); font-weight: 900;">COMO BAIXAR üêù</h2>
    <p style="font-size: 14px; margin-bottom: 30px; opacity: 0.8;">O seu navegador precisa de ajuda manual para instalar o app.</p>
    
    <div class="dl-step">
        <div class="dl-icon">1</div>
        <div>Toque no √≠cone de <b>Compartilhar</b> ou nos <b>tr√™s pontinhos</b> do navegador.</div>
    </div>
    
    <div class="dl-step">
        <div class="dl-icon">2</div>
        <div>Selecione <b>"Instalar Aplicativo"</b> ou <b>"Adicionar √† Tela de In√≠cio"</b>.</div>
    </div>
    
    <div class="dl-step">
        <div class="dl-icon">3</div>
        <div>Pronto! A abelha aparecer√° na sua tela inicial para jogar offline.</div>
    </div>
    
    <button onclick="document.getElementById('downloadOverlay').style.display='none'" style="width: 200px; background: var(--xp-bar); color: white; margin-top: 20px;">ENTENDI!</button>
</div>

<div id="minigameOverlay">
    <div id="mgCountdown">3</div>
    
    <div id="mgResultScreen">
        <h1 id="mgResultTitle">FIM DE JOGO</h1>
        <p style="font-size: 20px; margin-bottom: 5px;">Pontua√ß√£o: <span id="mgResultScore">0</span></p>
        <p id="mgResultBoosts" style="color: #4caf50; font-weight: 800; font-size: 14px; margin-bottom: 5px;"></p>
        <p id="mgResultReward" style="color: var(--accent); font-weight: 800; margin-bottom: 20px;"></p>
        <button onclick="closeMgResult()" style="width: 200px; background: var(--xp-bar); color: white;">REIVINDICAR</button>
    </div>

    <div class="mg-header">
        <div class="mg-stats-panel">
            <div class="mg-score-box">
                <span class="mg-label" id="mgLabelText">Tempo Restante</span>
                <span class="mg-val" id="mgCurrentScore">40s</span>
            </div>
            <div id="mgLiveBoosts"></div>
            <div id="rainHearts" style="display: none; font-size: 16px;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <div id="defenderHearts" style="display: none; font-size: 16px;">üêùüêùüêù</div>
        </div>
        <button onclick="exitMinigame()" style="width: auto; padding: 10px 20px; margin-top: 0; background: rgba(0,0,0,0.4); border: 1px solid white; color: white; border-radius: 12px;">SAIR</button>
    </div>
    
    <canvas id="snakeCanvas"></canvas>
    <canvas id="flightCanvas"></canvas>
    <canvas id="rainCanvas"></canvas>
    <canvas id="defenderCanvas"></canvas>

    <div id="snakeControls" class="mg-controls" style="display: none;">
        <div class="dpad-btn" style="grid-area: up;" ontouchstart="changeSnakeDir('UP')" onmousedown="changeSnakeDir('UP')">‚ñ≤</div>
        <div class="dpad-btn" style="grid-area: left;" ontouchstart="changeSnakeDir('LEFT')" onmousedown="changeSnakeDir('LEFT')">‚óÄ</div>
        <div class="dpad-btn" style="grid-area: down;" ontouchstart="changeSnakeDir('DOWN')" onmousedown="changeSnakeDir('DOWN')">‚ñº</div>
        <div class="dpad-btn" style="grid-area: right;" ontouchstart="changeSnakeDir('RIGHT')" onmousedown="changeSnakeDir('RIGHT')">‚ñ∂</div>
    </div>

    <div id="defenderControls" style="display: none; margin-top: 20px; width: 100%; max-width: 400px; display: flex; align-items: center; justify-content: center; gap: 15px;">
        <div class="dpad-btn" ontouchstart="moveDefender('LEFT')" onmousedown="moveDefender('LEFT')" ontouchend="stopDefender()" onmouseup="stopDefender()">‚óÄ</div>
        <div class="dpad-btn" ontouchstart="moveDefender('RIGHT')" onmousedown="moveDefender('RIGHT')" ontouchend="stopDefender()" onmouseup="stopDefender()">‚ñ∂</div>
        <div class="fire-btn" ontouchstart="defenderFire()" onmousedown="defenderFire()"></div>
    </div>

    <div id="flightControls" style="display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0;" ontouchstart="flightJump()" onmousedown="flightJump()"></div>
    <div id="flightHint" style="display: none; color: white; margin-top: 10px; font-weight: 800; opacity: 0.6;">TOQUE PARA SUBIR</div>
</div>

<div class="modal" id="missionsModal">
    <div class="modal-box">
        <div class="modal-header">
            <span>Agenda Real (10 Miss√µes) üìù</span>
            <span style="cursor:pointer" onclick="closeModal('missionsModal')">‚úñ</span>
        </div>
        <div class="modal-content-scroll" id="missionsList"></div>
        <div class="modal-footer" style="text-align: center; font-size: 11px; padding-top: 10px; color: inherit; opacity: 0.5;">
            Pr√≥ximo Ciclo: 22:00 Diariamente
        </div>
    </div>
</div>

<div class="modal" id="rerollModal">
    <div class="modal-box" style="text-align: center; padding: 20px;">
        <div style="font-size: 50px; margin-bottom: 15px;">üîÑ</div>
        <h2 id="rerollTitle" style="margin: 0 0 10px; color: var(--accent); font-weight: 900;">Nova Tarefa?</h2>
        <p style="font-size: 14px; line-height: 1.4; color: inherit; margin-bottom: 25px;">
            Voc√™ deseja trocar esta miss√£o por uma nova tarefa aleat√≥ria? 
            <br><small style="opacity: 0.7;">(O progresso atual ser√° perdido)</small>
        </p>
        <div style="display: flex; gap: 10px;">
            <button id="btnConfirmReroll" style="background: var(--xp-bar); color: white; margin-top: 0;">SIM, TROCAR</button>
            <button onclick="closeModal('rerollModal')" style="background: rgba(255,255,255,0.1); color: inherit; border: 1px solid rgba(255,255,255,0.3); margin-top: 0; box-shadow: none;">CANCELAR</button>
        </div>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-box">
        <div class="modal-header">
            <span>Ajustes Reais ‚öôÔ∏è</span>
            <span style="cursor:pointer" onclick="closeModal('settingsModal')">‚úñ</span>
        </div>
        <div class="modal-content-scroll">
            
            <div class="section-title">AUDIO & SOM üîä</div>
            <div class="config-group-card">
                <div class="config-row">
                    <div class="config-label"><span>M√∫sica üéµ</span><span id="musicVolLabel">50%</span></div>
                    <input type="range" id="musicVol" min="0" max="100" value="50" oninput="updateVolume('music')">
                </div>
                <div class="config-row">
                    <div class="config-label"><span>Efeito Click üîä</span><span id="clickVolLabel">80%</span></div>
                    <input type="range" id="clickVol" min="0" max="100" value="80" oninput="updateVolume('click')">
                </div>
                <div class="config-row">
                    <div class="config-label"><span>Efeito Level Up ‚ú®</span><span id="lvlUpVolLabel">100%</span></div>
                    <input type="range" id="lvlUpVol" min="0" max="100" value="100" oninput="updateVolume('lvlUp')">
                </div>
            </div>

            <div class="section-title">INTERFACE üé®</div>
            <div class="config-group-card">
                <div class="config-row">
                    <div class="config-label">
                        <span>Cor Principal do Tema</span>
                        <input type="color" id="uiMainColor" value="#071B87" oninput="updateTheme()">
                    </div>
                </div>
                <div class="config-row">
                    <div class="config-label"><span>Opacidade dos Pain√©is</span><span id="uiOpacityLabel">85%</span></div>
                    <input type="range" id="uiOpacity" min="10" max="100" value="85" oninput="updateTheme()">
                </div>
            </div>

            <div class="config-group-card" style="margin-top: 20px;">
                <div id="pwaStatusArea">
                    <button id="btnPwaAction" style="display: none; background: var(--xp-bar); color: white; margin-top:0; height: 45px; font-size: 12px;"></button>
                    <div id="pwaInstalledMsg" style="display: none; text-align: center; font-size: 11px; color: var(--xp-bar); font-weight: 800;">
                        SISTEMA SINCRONIZADO ‚úÖ
                    </div>
                </div>
                <button id="btnExitToMain" onclick="returnToMain()" style="background: #e74c3c; color: white; border: none; box-shadow: 0 4px 0 #c0392b; margin-top: 15px; height: 45px; font-size: 12px;">SAIR PARA O IN√çCIO üö™</button>
            </div>
            
            <div class="version-tag" id="configVersionDisplay">BEEKIND v0.0.0</div>
        </div>
    </div>
</div>

<div class="modal" id="changelogModal">
    <div class="modal-box">
        <div class="modal-header">
            <span>Hist√≥rico Real üìú</span>
            <span style="cursor:pointer" onclick="closeModal('changelogModal')">‚úñ</span>
        </div>
        <div class="modal-content-scroll" id="changelogContent"></div>
        <div class="modal-footer">
            <button onclick="closeModal('changelogModal')" style="margin-top: 0;">ENTENDIDO!</button>
        </div>
    </div>
</div>

<div class="modal" id="offlineModal">
    <div class="modal-box" style="border: 2px solid var(--accent);">
        <div class="modal-header" style="background: var(--bg-gradient); color: white;">
            <span>Boas-vindas Reais! üêù</span>
        </div>
        <div class="modal-content-scroll" style="text-align: center; padding: 30px 20px;">
            <div id="offlineIcon" style="width: 90px; height: 90px; background: rgba(255, 204, 0, 0.1); border: 2px solid var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 45px; animation: floatBee 3s infinite;">üçØ</div>
            <h2 id="offlineTitle" style="margin: 0 0 5px; font-weight: 900; color: var(--accent);">A sua colmeia trabalhou!</h2>
            <p id="offlineTimeText" style="font-size: 12px; opacity: 0.7; margin-bottom: 20px;">Voc√™ esteve fora por: 0h 0m</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 10px; font-weight: 800; opacity: 0.6;">MEL COLETADO</div>
                    <div style="font-size: 18px; font-weight: 900; color: var(--accent);" id="offlineHoneyVal">+0</div>
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 10px; font-weight: 800; opacity: 0.6;">XP GANHO</div>
                    <div style="font-size: 18px; font-weight: 900; color: var(--xp-bar);" id="offlineXpVal">+0</div>
                </div>
            </div>
            
            <p style="font-size: 11px; margin-top: 20px; opacity: 0.5; font-style: italic;">"O Rei agradece a dedica√ß√£o das abelhas oper√°rias."</p>
        </div>
        <div class="modal-footer">
            <button id="btnCollectOffline" onclick="collectOfflineRewards()" style="background:var(--xp-bar); color:white; box-shadow:0 6px 0 rgba(0,0,0,0.3); height: 60px; font-size: 18px; text-transform: uppercase;">REIVINDICAR TUDO</button>
        </div>
    </div>
</div>

<div class="modal" id="dailyRewardModal">
    <div class="modal-box">
        <div class="modal-header">
            <span>Pr√™mios de Login üéÅ</span>
            <span style="cursor:pointer" onclick="closeModal('dailyRewardModal')">‚úñ</span>
        </div>
        <div class="modal-content-scroll" style="text-align: center;">
            <h3 style="margin-top:0; color:var(--accent);">CICLO DE 7 DIAS</h3>
            <p style="font-size:12px; opacity:0.8; margin-bottom:20px;">Entre todos os dias para acumular pr√™mios reais!</p>
            <div id="dailyGrid" class="daily-grid"></div>
        </div>
        <div class="modal-footer">
            <button id="btnClaimDaily" onclick="claimDailyReward()" style="background:var(--xp-bar); color:white;">RESGATAR HOJE</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('touchstart', function (event) {
  if (event.touches.length > 1) {
    event.preventDefault();
  }
}, { passive: false });

let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  let now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

document.addEventListener('gesturestart', function (event) {
  event.preventDefault();
});

let deferredPrompt;
let newWorker;
let pwaState = 'install';

if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
  navigator.serviceWorker.register('./sw.js').then(reg => {
    reg.addEventListener('updatefound', () => {
      newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          syncPwaUI('update');
        }
      });
    });
  }).catch(e => console.warn("Modo Local: SW n√£o registrado."));
}

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  syncPwaUI('install');
});

if (!window.matchMedia('(display-mode: standalone)').matches) {
    window.addEventListener('load', () => {
        const btn = document.getElementById('pwaMainActionBtn');
        if(btn) btn.style.display = 'flex';
    });
} else {
    window.addEventListener('load', () => {
        const btn = document.getElementById('pwaMainActionBtn');
        const msg = document.getElementById('pwaInstalledMsg');
        if(btn) btn.style.display = 'none';
        if(msg) msg.style.display = 'block';
    });
}

function syncPwaUI(state) {
    pwaState = state;
    const mainBtn = document.getElementById('pwaMainActionBtn');
    const configBtn = document.getElementById('btnPwaAction');
    const icon = document.getElementById('pwaIcon');

    if (state === 'install') {
        if(mainBtn) {
            mainBtn.style.display = 'flex';
            mainBtn.classList.remove('aura-pulse');
            icon.textContent = 'üì•';
        }
        if(configBtn) {
            configBtn.style.display = 'block';
            configBtn.innerHTML = 'BAIXAR APP (OFFLINE)';
        }
    } else if (state === 'update') {
        if(mainBtn) {
            mainBtn.style.display = 'flex';
            mainBtn.classList.add('aura-pulse');
            icon.textContent = 'üîÑ';
        }
        if(configBtn) {
            configBtn.style.display = 'block';
            configBtn.innerHTML = 'ATUALIZAR JOGO AGORA';
        }
    }
}

async function handlePwaClick() {
    if (pwaState === 'install') {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                const btn = document.getElementById('pwaMainActionBtn');
                if(btn) btn.style.display = 'none';
            }
            deferredPrompt = null;
        } else {
            const overlay = document.getElementById('downloadOverlay');
            if(overlay) overlay.style.display = 'flex';
        }
    } else if (pwaState === 'update') {
        if (newWorker) newWorker.postMessage({ action: 'skipWaiting' });
        window.location.reload();
    }
}

// HIST√ìRICO DE ATUALIZA√á√ïES
let updateHistory = [
    {
        version: "23.0.0",
        title: "‚öñÔ∏è VENDA CONTROLADA",
        changes: [
            { type: "add", text: "Mercado: Agora o player escolhe a quantidade exata de garrafas que quer vender via input ou bot√µes r√°pidos." },
            { type: "add", text: "L√≥gica: Venda din√¢mica retira primeiro do invent√°rio e completa com o laborat√≥rio automaticamente." },
            { type: "mod", text: "Interface: Preview de ganho de Coroas adicionado ao painel do Velho Dudu." }
        ]
    },
    {
        version: "22.0.0",
        title: "üé® LOJA REFORMULADA",
        changes: [
            { type: "mod", text: "Visual: Nova interface de boosts organizada em cart√µes com categorias claras." }
        ]
    }
];

function updateVersionDisplay() {
    const configDisplay = document.getElementById("configVersionDisplay");
    if(updateHistory.length > 0) {
        if(configDisplay) configDisplay.textContent = `BEEKIND v.${updateHistory[0].version}`;
    }
}

function renderChangelog() {
    const container = document.getElementById("changelogContent");
    if(!container) return;
    container.innerHTML = "";
    const recentUpdates = updateHistory.slice(0, 5);
    recentUpdates.forEach(update => {
        let blockHtml = `<div class="changelog-block"><div class="changelog-section-title">v${update.version} - ${update.title}</div><div class="changelog-list">`;
        update.changes.forEach(change => {
            let icon = "üîπ";
            if(change.type === "add") icon = "üü¢";
            if(change.type === "fix") icon = "üîµ";
            if(change.type === "mod") icon = "üü°";
            blockHtml += `<div class="changelog-item"><span class="changelog-icon">${icon}</span><span>${change.text}</span></div>`;
        });
        blockHtml += `</div></div>`;
        container.innerHTML += blockHtml;
    });
}

function checkUpdateStatus() {
    const hasBeenAccessed = localStorage.getItem("BeeKind_ChangelogAccessed_V23"); 
    const btn = document.getElementById("btnChangelog");
    if(!btn) return;
    if(!hasBeenAccessed) btn.classList.add("btn-chromatic-pulse");
    else btn.classList.remove("btn-chromatic-pulse");
}

function openChangelog() { 
    localStorage.setItem("BeeKind_ChangelogAccessed_V23", "true");
    checkUpdateStatus();
    renderChangelog(); 
    openModal('changelogModal'); 
}

const SAVE_KEY = "BeeRoyal_Balance_V2";
const AUDIO_KEY = "BeeRoyal_Audio_V1";
const MISSION_KEY = "BeeRoyal_Missions_V2";
const THEME_KEY = "BeeRoyal_Theme_V1";
const RECORDS_KEY = "BeeRoyal_Records_V1";
const DAILY_REWARD_KEY = "BeeRoyal_Daily_V2";

function validateNum(n) {
    if (isNaN(n) || n === undefined || n === null || n < 0) return 0;
    return parseFloat(n);
}

let honey = 0, totalHoneyEver = 0, crowns = 0, honeyBottles = 0, hPerClick = 0.2, level = 1;
let currentXP = 0, nextLevelXP = 1000, autoUnlocked = true;

/* LAB STATE */
let isLabWorking = false;
let labTimeLeft = 0;
const LAB_PROCESS_TIME = 45; 
const SLOT_CAPACITY = 9;
const TOTAL_SLOTS = 12;
let labSlots = Array(TOTAL_SLOTS).fill(0); 
let currentBatch = 1; 

let talentPoints = 0;
let talents = {
    operario_forca: 0, 
    operario_critico: 0, 
    arquiteto_mps: 0, 
    arquiteto_offline: 0, 
    alquimista_sorte: 0, 
    alquimista_boost: 0 
};

let hiveOwned = { base: true, middle: false, top: false };
const HIVE_COSTS = { middle: 500000, top: 2500000 };
let queenProductionLevel = 0;

let hangarsCount = 1;
let expeditions = [
    { id: 0, active: false, startTime: 0, duration: 300000, reductionPerc: 0, biome: 'clover', eventChance: 0, finished: false, pendingRewards: null, uses: 0, selectedPerc: 50 },
    { id: 1, active: false, startTime: 0, duration: 300000, reductionPerc: 0, biome: 'clover', eventChance: 0, finished: false, pendingRewards: null, uses: 0, selectedPerc: 50 },
    { id: 2, active: false, startTime: 0, duration: 300000, reductionPerc: 0, biome: 'clover', eventChance: 0, finished: false, pendingRewards: null, uses: 0, selectedPerc: 50 },
    { id: 3, active: false, startTime: 0, duration: 300000, reductionPerc: 0, biome: 'clover', eventChance: 0, finished: false, pendingRewards: null, uses: 0, selectedPerc: 50 }
];
const HANGAR_COSTS = [0, 50000, 250000, 1000000];

let ownedCosmetics = ["Bee", "NoelBee", "SkullBee", "FairyBee"], equippedCosmetic = "NoelBee", equippedBackground = "BgPadrao", pendingOfflineHoney = 0, pendingOfflineXP = 0;
let activeBoosts = { pepper: 0, energy: 0, flower: 0, luck: 0, crown: 0, jelly: 0, magnet: 0 }; 
let clickBuffer = [], gameLoaded = false;
let currentAchFilter = 'all', autoProduceInterval = null, gameTickInterval = null;
let dailyMissions = [];
let lastMissionReset = 0;
let audioSettings = { music: 50, click: 80, lvlUp: 100 };
let themeSettings = { mainColor: "#071B87", opacity: 0.85 };
let records = { snake: 0, flight: 0, rain: 0, defender: 0 };
let defenderProgress = { level: 1, lastPlayed: 0 };
let pendingRerollId = null;

let dailyState = { streak: 0, lastClaim: 0, claimedToday: false };
const dailyCycle = [
    { type: 'honey', val: 5000, icon: 'üçØ' },
    { type: 'xp', val: 2000, icon: '‚ú®' },
    { type: 'honey', val: 15000, icon: 'üçØ' },
    { type: 'boost', boost: 'pepper', ticks: 1800, icon: 'üå∂Ô∏è', label: '3m' },
    { type: 'honey', val: 50000, icon: 'üçØ' },
    { type: 'xp', val: 10000, icon: '‚ú®' },
    { type: 'super', val: 200000, boost: 'crown', ticks: 1800, icon: 'üëë', label: 'REI' }
];

const soundMusic = new Audio('Music.mp3');
const soundClick = new Audio('Click.mp3');
const soundLvlUp = new Audio('LvlUp.mp3');
soundMusic.loop = true;

let activeMG = null;
let mgInterval = null;
let mgRunning = false;
let mgScore = 0;
let mgSpeed = 150;

let snake = [];
let snakeFood = {x: 0, y: 0};
let sdx = 20, sdy = 0, snextDx = 20, snextDy = 0;
let snakeBoost = null; 
let snakeBoostTimer = 0; 
let snakeBoostLife = 0; 
const snakeCanvas = document.getElementById("snakeCanvas");
const snakeCtx = snakeCanvas ? snakeCanvas.getContext("2d") : null;

let fBeeY = 150, fVelocity = 0, fGravity = 0.5, fJump = -7;
let fPipes = [];
let fBoosts = []; 
let fCollectedBoosts = []; 
const flightCanvas = document.getElementById("flightCanvas");
const flightCtx = flightCanvas ? flightCanvas.getContext("2d") : null;
const beeSprite = new Image();
beeSprite.src = 'Bee.png';

const rainCanvas = document.getElementById("rainCanvas");
const rainCtx = rainCanvas ? rainCanvas.getContext("2d") : null;
const rainBeeSprite = new Image();
rainBeeSprite.src = 'Bee.png';

let rBeeX = 135;
let rBeeTargetX = 135;
let rBeeDirChangeTimer = 0;
let rDrops = [];
let rHearts = 3;
let rBeeSpeed = 2;
let rDropSpeed = 1.5;
let rSpawnTimer = 0;
let rBeeYOffset = 0; 

const defenderCanvas = document.getElementById("defenderCanvas");
const defenderCtx = defenderCanvas ? defenderCanvas.getContext("2d") : null;
const defenderBeeSprite = new Image();
defenderBeeSprite.src = 'BeeUp.png';

let dPlayerX = 135;
let dBullets = [];
let dEnemies = [];
let dEnemyBullets = [];
let dModDrops = [];
let dEnemyDir = 1;
let dEnemyDirTimer = 0;
let dEnemyTimer = 40; 
let dMoving = 0; 
let dGameTimer = null;
let dHearts = 3;
let dFireCooldown = 0; 
let dHasDoubleShot = false;

window.addEventListener('keydown', (e) => {
    if(!mgRunning) return;
    const key = e.key.toLowerCase();
    if(activeMG === 'snake') {
        if ((key === 'arrowup' || key === 'w')) changeSnakeDir('UP');
        if ((key === 'arrowdown' || key === 's')) changeSnakeDir('DOWN');
        if ((key === 'arrowleft' || key === 'a')) changeSnakeDir('LEFT');
        if ((key === 'arrowright' || key === 'd')) changeSnakeDir('RIGHT');
    } else if(activeMG === 'flight') {
        if(e.code === 'Space' || key === 'w' || key === 'arrowup') flightJump();
    } else if(activeMG === 'defender') {
        if (key === 'arrowleft' || key === 'a') dMoving = -1;
        if (key === 'arrowright' || key === 'd') dMoving = 1;
        if (e.code === 'Space' || key === 'w' || key === 'arrowup') defenderFire();
    }
});

window.addEventListener('keyup', (e) => {
    if(!mgRunning || activeMG !== 'defender') return;
    const key = e.key.toLowerCase();
    if (key === 'arrowleft' || key === 'a' || key === 'arrowright' || key === 'd') dMoving = 0;
});

function togglePanel(show) {
    const panel = document.getElementById('mainPanel');
    const closeBtn = document.getElementById('btnClosePanel');
    const stats = document.getElementById('statsCard');
    const notif = document.querySelector('.notif-card');
    const click = document.getElementById('clickCard');

    if (show) {
        panel.classList.add('is-full');
        closeBtn.style.display = 'flex';
        stats.style.display = 'none';
        if(notif) notif.style.display = 'none';
        click.style.display = 'none';
    } else {
        panel.classList.remove('is-full');
        closeBtn.style.display = 'none';
        stats.style.display = 'block';
        if(notif) notif.style.display = 'flex';
        click.style.display = 'flex';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    }
}

function updateTheme() {
    const colorEl = document.getElementById('uiMainColor');
    const opacityEl = document.getElementById('uiOpacity');
    if(!colorEl || !opacityEl) return;
    const color = colorEl.value;
    const opacity = opacityEl.value;
    themeSettings.mainColor = color;
    themeSettings.opacity = parseFloat(opacity) / 100;
    const label = document.getElementById('uiOpacityLabel');
    if(label) label.textContent = opacity + '%';
    applyTheme();
    localStorage.setItem(THEME_KEY, JSON.stringify(themeSettings));
}

function getLuminance(hex) {
    const r = parseInt(hex.slice(1, 3), 16) / 255;
    const g = parseInt(hex.slice(3, 5), 16) / 255;
    const b = parseInt(hex.slice(5, 7), 16) / 255;
    const a = [r, g, b].map(v => {
        return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
    });
    return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
}

function applyTheme() {
    const root = document.querySelector(':root');
    const color = themeSettings.mainColor;
    const opacity = themeSettings.opacity;
    const luminance = getLuminance(color);
    const textColor = luminance > 0.5 ? "#030d45" : "#ffffff";
    const accentColor = luminance > 0.8 ? "#e67e22" : "#ffcc00"; 
    const r = parseInt(color.slice(1, 3), 16), g = parseInt(color.slice(3, 5), 16), b = parseInt(color.slice(5, 7), 16);
    const darken = 0.6;
    const rD = Math.floor(r * darken), gD = Math.floor(g * darken), bD = Math.floor(b * darken);
    root.style.setProperty('--main-blue', color);
    root.style.setProperty('--card-opacity', opacity);
    root.style.setProperty('--text-color', textColor);
    root.style.setProperty('--accent', accentColor);
    root.style.setProperty('--card', `linear-gradient(145deg, rgba(${r}, ${g}, ${b}, ${opacity}), rgba(${rD}, ${gD}, ${bD}, 0.9))`);
    root.style.setProperty('--bg-gradient', `linear-gradient(180deg, ${color}, rgb(${rD}, ${gD}, ${bD}))`);
    const startScreen = document.getElementById('startScreen');
    if(startScreen) startScreen.style.background = `linear-gradient(180deg, ${color}, rgb(${rD}, ${gD}, ${bD}))`;
}

function prepareMinigame(type) { startMinigameActual(type); }

function startMinigameActual(type) {
    activeMG = type;
    const overlay = document.getElementById("minigameOverlay");
    if(overlay) overlay.style.display = "flex";
    document.querySelectorAll('#mgResultScreen, #snakeCanvas, #flightCanvas, #rainCanvas, #defenderCanvas, #snakeControls, #flightControls, #defenderControls, #rainHearts, #defenderHearts, #flightHint').forEach(el => {
        if(el) el.style.display = "none";
    });
    const countdownEl = document.getElementById("mgCountdown");
    if(countdownEl) {
        countdownEl.style.display = "block";
        let count = 3; countdownEl.textContent = count;
        const countTimer = setInterval(() => {
            count--;
            if(count > 0) countdownEl.textContent = count;
            else if(count === 0) countdownEl.textContent = "GO!";
            else { clearInterval(countTimer); countdownEl.style.display = "none"; startMG(); }
        }, 800);
    }
}

function startMG() {
    mgScore = 0; 
    const scoreVal = document.getElementById("mgCurrentScore");
    if(scoreVal) scoreVal.textContent = "0"; 
    mgRunning = true;
    if(activeMG === 'snake') {
        const canv = document.getElementById("snakeCanvas"); const cont = document.getElementById("snakeControls");
        if(canv) canv.style.display = "block"; if(cont) cont.style.display = "grid";
        mgSpeed = 320; initSnake();
    } else if(activeMG === 'flight') {
        const canv = document.getElementById("flightCanvas"); const cont = document.getElementById("flightControls"); const hint = document.getElementById("flightHint");
        if(canv) canv.style.display = "block"; if(cont) cont.style.display = "block"; if(hint) hint.style.display = "block";
        initFlight();
    } else if(activeMG === 'rain') {
        const canv = document.getElementById("rainCanvas"); const hearts = document.getElementById("rainHearts");
        if(canv) canv.style.display = "block"; if(hearts) hearts.style.display = "block";
        initRain();
    } else if(activeMG === 'defender') {
        const canv = document.getElementById("defenderCanvas"); const cont = document.getElementById("defenderControls"); const hearts = document.getElementById("defenderHearts");
        if(canv) canv.style.display = "block"; if(cont) cont.style.display = "flex"; if(hearts) hearts.style.display = "block";
        initDefender();
    }
}

function updateMgLiveBoostsVisual() {
    const container = document.getElementById("mgLiveBoosts"); if(!container) return; container.innerHTML = "";
    fCollectedBoosts.forEach(b => { const span = document.createElement("span"); span.className = "mg-live-boost-icon"; span.textContent = b.icon; container.appendChild(span); });
    if(activeMG === 'defender' && dHasDoubleShot) { const span = document.createElement("span"); span.className = "mg-live-boost-icon"; span.textContent = "üî´"; container.appendChild(span); }
}

function initDefender() {
    if(!defenderCanvas) return;
    defenderCanvas.width = 300; defenderCanvas.height = 300;
    dPlayerX = 135; dBullets = []; dEnemies = []; dEnemyBullets = []; dModDrops = []; dEnemyDir = 1; dEnemyTimer = 40; dMoving = 0; fCollectedBoosts = [];
    dHearts = 3; dFireCooldown = 0; dHasDoubleShot = false;
    updateDefenderHearts();
    const currentLevel = defenderProgress.level;
    for(let row=0; row<3; row++) {
        for(let col=0; col<6; col++) {
            let hp = 1; let type = 'common';
            if(currentLevel >= 4 && row === 0) { hp = 2; type = 'elite'; }
            dEnemies.push({ x: 30 + col*40, y: 30 + row*35, alive: true, hp: hp, type: type, diving: false, diveDir: 1, diveSpeed: 2.5 + (currentLevel * 0.2), baseY: 30 + row*35 });
        }
    }
    if(mgInterval) clearInterval(mgInterval); mgInterval = setInterval(drawDefender, 20);
    if(dGameTimer) clearInterval(dGameTimer);
    dGameTimer = setInterval(() => {
        if(mgRunning && activeMG === 'defender') { dEnemyTimer--; const scoreVal = document.getElementById("mgCurrentScore"); if(scoreVal) scoreVal.textContent = dEnemyTimer + "s"; if(dEnemyTimer <= 0) finishMG(); }
    }, 1000);
}

function updateDefenderHearts() { const el = document.getElementById("defenderHearts"); if(el) el.textContent = "üêù".repeat(Math.max(0, dHearts)); }

function moveDefender(dir) { dMoving = (dir === 'LEFT' ? -1 : 1); }
function stopDefender() { dMoving = 0; }
function defenderFire() {
    if(!mgRunning || activeMG !== 'defender' || dFireCooldown > 0) return;
    if(dHasDoubleShot) { dBullets.push({x: dPlayerX + 5, y: 260}); dBullets.push({x: dPlayerX + 25, y: 260}); }
    else { dBullets.push({x: dPlayerX + 15, y: 260}); }
    dFireCooldown = 25; playClickSound();
}

function drawDefender() {
    if(!defenderCtx) return;
    defenderCtx.fillStyle = "#000"; defenderCtx.fillRect(0, 0, 300, 300);
    if(dFireCooldown > 0) dFireCooldown--;
    dPlayerX += dMoving * 4; if(dPlayerX < 0) dPlayerX = 0; if(dPlayerX > 270) dPlayerX = 270;
    if(defenderBeeSprite.complete) { defenderCtx.save(); defenderCtx.translate(dPlayerX + 15, 260 + 15); defenderCtx.rotate(Math.PI / 2); defenderCtx.scale(1, -1); defenderCtx.drawImage(defenderBeeSprite, -15, -15, 30, 30); defenderCtx.restore(); }
    dBullets.forEach((b, i) => { b.y -= 5; defenderCtx.fillStyle = dHasDoubleShot ? "#00ffff" : varProp('--accent'); defenderCtx.fillRect(b.x - 1, b.y, 2, 8); if(b.y < 0) dBullets.splice(i, 1); });
    dEnemyBullets.forEach((eb, i) => { eb.y += 3; defenderCtx.fillStyle = "#ff4757"; defenderCtx.fillRect(eb.x - 1, eb.y, 2, 8); if(eb.x > dPlayerX && eb.x < dPlayerX + 30 && eb.y > 260 && eb.y < 290) { dHearts--; updateDefenderHearts(); dEnemyBullets.splice(i, 1); if(dHearts <= 0) finishMG(); } if(eb.y > 300) dEnemyBullets.splice(i, 1); });
    dModDrops.forEach((m, i) => { m.y += 2; defenderCtx.font = "20px Arial"; defenderCtx.fillText("üî´", m.x, m.y); if(m.x > dPlayerX && m.x < dPlayerX + 30 && m.y > 250 && m.y < 290) { dHasDoubleShot = true; updateMgLiveBoostsVisual(); dModDrops.splice(i, 1); notify({n: "TIRO DUPLO ATIVADO!"}); } else if(m.y > 300) { dModDrops.splice(i, 1); } });
    let hitSide = false; let aliveEnemies = dEnemies.filter(e => e.alive);
    if(Math.random() < (0.015 + (defenderProgress.level * 0.005)) && aliveEnemies.length > 0) {
        let shooter = aliveEnemies[Math.floor(Math.random() * aliveEnemies.length)];
        if(!shooter.diving) { if(Math.random() > 0.4) { dEnemyBullets.push({x: shooter.x + 12, y: shooter.y + 20}); } else { shooter.diving = true; shooter.diveDir = 1; } }
    }
    dEnemies.forEach(e => {
        if(!e.alive) return;
        if(!e.diving) { e.x += dEnemyDir * (0.4 + defenderProgress.level * 0.1); if(e.x > 270 || e.x < 0) hitSide = true; }
        else { e.y += e.diveSpeed * e.diveDir; if(e.y > 270) e.diveDir = -1; if(e.y <= e.baseY && e.diveDir === -1) { e.y = e.baseY; e.diving = false; } if(e.x > dPlayerX - 20 && e.x < dPlayerX + 30 && e.y > 250 && e.y < 290) { dHearts--; updateDefenderHearts(); e.alive = false; if(dHearts <= 0) finishMG(); } }
        defenderCtx.save(); defenderCtx.font = "24px Arial"; defenderCtx.translate(e.x + 12, e.y - 10); defenderCtx.rotate(Math.PI);
        let emoji = (e.type === 'elite') ? "ü™≤" : "ü™∞";
        if(e.type === 'elite') { defenderCtx.fillStyle = "#fffa65"; defenderCtx.fillText(emoji, -12, 10); defenderCtx.strokeStyle = "#ff4757"; defenderCtx.lineWidth = 1; defenderCtx.strokeText(emoji, -12, 10); } else { defenderCtx.fillStyle = "#fff"; defenderCtx.fillText(emoji, -12, 10); } defenderCtx.restore();
        dBullets.forEach((b, bi) => { if(b.x > e.x && b.x < e.x + 25 && b.y > e.y - 20 && b.y < e.y) { e.hp--; dBullets.splice(bi, 1); if(e.hp <= 0) { e.alive = false; mgScore++; updateMissionProgress('mg_kills', 1); if(Math.random() < 0.08) dModDrops.push({x: e.x + 10, y: e.y}); if(Math.random() < 0.005) { const types = ['pepper', 'energy', 'flower', 'luck']; const icons = { pepper: 'üå∂Ô∏è', energy: 'ü•§', flower: 'üåº', luck: 'üçÄ' }; const t = types[Math.floor(Math.random()*4)]; fCollectedBoosts.push({type: t, icon: icons[t]}); updateMgLiveBoostsVisual(); } } } });
    });
    if(hitSide) dEnemyDir *= -1;
    if(dEnemies.every(e => !e.alive)) { mgScore += 50; if(defenderProgress.level < 7) defenderProgress.level++; defenderProgress.lastPlayed = Date.now(); finishMG(); }
}

function initRain() {
    if(!rainCanvas) return;
    rainCanvas.width = 300; rainCanvas.height = 300;
    rBeeX = 135; rBeeTargetX = 135; rDrops = []; rHearts = 3; rBeeSpeed = 2; rDropSpeed = 1.5; rSpawnTimer = 0; rBeeDirChangeTimer = 0; rBeeYOffset = 0; fCollectedBoosts = []; updateRainHearts();
    rainCanvas.onclick = (e) => {
        if(!mgRunning) return; const rect = rainCanvas.getBoundingClientRect(); const mouseX = (e.clientX - rect.left) * (300 / rect.width); const mouseY = (e.clientY - rect.top) * (300 / rect.height);
        rDrops.forEach((d, i) => {
            const dist = Math.sqrt((mouseX - d.x)**2 + (mouseY - d.y)**2);
            if(dist < 25) { if(d.isBomb) { rHearts--; updateRainHearts(); createRainParticles(d.x, d.y, "#ff0000", 20); rDrops.splice(i, 1); if(rHearts <= 0) finishMG(); } else if(d.isBoost) { fCollectedBoosts.push({type: d.boostType, icon: d.boostIcon}); updateMgLiveBoostsVisual(); createRainParticles(d.x, d.y, "#ffffff", 15); playClickSound(); rDrops.splice(i, 1); updateMissionProgress('mg_boost_collect', 1); } else { rDrops.splice(i, 1); mgScore++; updateMissionProgress('mg_item_collect', 1); const scoreVal = document.getElementById("mgCurrentScore"); if(scoreVal) scoreVal.textContent = mgScore; createRainParticles(d.x, d.y, "#ffcc00", 12); playClickSound(); } }
        });
    };
    if(mgInterval) clearInterval(mgInterval); mgInterval = setInterval(drawRain, 20);
}

function createRainParticles(x, y, color, count) {
    for(let i=0; i<count; i++) {
        const p = document.createElement("div"); p.className = "honey-particle"; p.style.background = color; p.style.left = `calc(50vw - 150px + ${x}px)`; p.style.top = `calc(50vh - 150px + ${y}px)`; const angle = Math.random() * Math.PI * 2; const dist = Math.random() * 50 + 20; p.style.setProperty('--tx', `${Math.cos(angle) * dist}px`); p.style.setProperty('--ty', `${Math.sin(angle) * dist}px`); document.body.appendChild(p); setTimeout(() => p.remove(), 500);
    }
}

function updateRainHearts() { const el = document.getElementById("rainHearts"); if(el) el.textContent = "‚ù§Ô∏è".repeat(Math.max(0, rHearts)); }

function drawRain() {
    if(!rainCtx) return;
    rainCtx.fillStyle = "#000"; rainCtx.fillRect(0, 0, 300, 300);
    rBeeDirChangeTimer--; if(rBeeDirChangeTimer <= 0) { rBeeTargetX = Math.random() * 260; rBeeDirChangeTimer = Math.random() * 60 + 20; rBeeSpeed = (2 + (mgScore * 0.05)) * (Math.random() * 1.5 + 0.5); }
    let movingRight = rBeeTargetX > rBeeX; if(Math.abs(rBeeX - rBeeTargetX) > 2) { rBeeX += (movingRight ? 1 : -1) * rBeeSpeed; }
    rBeeYOffset = Math.sin(Date.now() / 150) * 8;
    if(rainBeeSprite.complete) { rainCtx.save(); if(!movingRight) { rainCtx.translate(rBeeX + 40, 0); rainCtx.scale(-1, 1); rainCtx.drawImage(rainBeeSprite, 0, 10 + rBeeYOffset, 40, 40); } else { rainCtx.drawImage(rainBeeSprite, rBeeX, 10 + rBeeYOffset, 40, 40); } rainCtx.restore(); }
    rSpawnTimer++; const spawnThreshold = Math.max(10, 45 - Math.floor(mgScore/4));
    if(rSpawnTimer > spawnThreshold) {
        const rng = Math.random(); let isBomb = rng < 0.35; let isBoost = !isBomb && rng < 0.005; let drop = { x: rBeeX + 20, y: 45 + rBeeYOffset, isBomb: isBomb, isBoost: isBoost };
        if(isBoost) { const types = ['pepper', 'energy', 'flower', 'luck']; const icons = { pepper: 'üå∂Ô∏è', energy: 'ü•§', flower: 'üåº', luck: 'üçÄ' }; drop.boostType = types[Math.floor(Math.random() * types.length)]; drop.boostIcon = icons[drop.boostType]; }
        rDrops.push(drop); rSpawnTimer = 0;
    }
    rDrops.forEach((d, i) => {
        d.y += rDropSpeed; rainCtx.font = "24px Arial"; rainCtx.textAlign = "center";
        let icon = d.isBomb ? "üí£" : (d.isBoost ? d.boostIcon : "üçØ");
        rainCtx.fillText(icon, d.x, d.y); if(d.y > 295) { rDrops.splice(i, 1); if(!d.isBomb && !d.isBoost) { rHearts--; updateRainHearts(); if(rHearts <= 0) finishMG(); } }
    });
    rDropSpeed = 1.5 + (mgScore * 0.04);
}

function initSnake() {
    if(!snakeCanvas) return;
    snakeCanvas.width = 300; snakeCanvas.height = 300; snake = [{x: 140, y: 140}, {x: 120, y: 140}, {x: 100, y: 140}]; sdx = 20; sdy = 0; snextDx = 20; snextDy = 0; fCollectedBoosts = []; snakeBoost = null; snakeBoostTimer = 0; snakeBoostLife = 0; createSnakeFood(); startSnakeLoop();
}

function startSnakeLoop() { if(mgInterval) clearInterval(mgInterval); mgInterval = setInterval(drawSnake, mgSpeed); }

function createSnakeFood() { if(!snakeCanvas) return; snakeFood.x = Math.floor(Math.random() * (snakeCanvas.width / 20)) * 20; snakeFood.y = Math.floor(Math.random() * (snakeCanvas.height / 20)) * 20; }

function spawnSnakeBoost() {
    if(!snakeCanvas) return; if(Math.random() > 0.7) return;
    const types = ['pepper', 'energy', 'flower', 'luck']; const icons = { pepper: 'üå∂Ô∏è', energy: 'ü•§', flower: 'üåº', luck: 'üçÄ' }; const type = types[Math.floor(Math.random() * types.length)];
    let bx, by; let valid = false; while(!valid) { bx = Math.floor(Math.random() * (snakeCanvas.width / 20)) * 20; by = Math.floor(Math.random() * (snakeCanvas.height / 20)) * 20; valid = !snake.some(s => s.x === bx && s.y === by) && (bx !== snakeFood.x || by !== snakeFood.y); }
    snakeBoost = { x: bx, y: by, type: type, icon: icons[type] }; snakeBoostLife = 5000; 
}

function drawSnake() {
    if(!snakeCtx || !snakeCanvas) return;
    snakeBoostTimer += mgSpeed; if(snakeBoostTimer >= 40000) { spawnSnakeBoost(); snakeBoostTimer = 0; }
    if(snakeBoost) { snakeBoostLife -= mgSpeed; if(snakeBoostLife <= 0) snakeBoost = null; }
    sdx = snextDx; sdy = snextDy; const head = {x: snake[0].x + sdx, y: snake[0].y + sdy};
    if (head.x < 0 || head.x >= snakeCanvas.width || head.y < 0 || head.y >= snakeCanvas.height || snake.some(s => s.x === head.x && s.y === head.y)) { finishMG(); return; }
    snake.unshift(head);
    if(head.x === snakeFood.x && head.y === snakeFood.y) { mgScore++; const scoreVal = document.getElementById("mgCurrentScore"); if(scoreVal) scoreVal.textContent = mgScore; updateMissionProgress('mg_item_collect', 1); createSnakeFood(); if(mgScore % 2 === 0 && mgSpeed > 60) { mgSpeed *= 0.97; startSnakeLoop(); } } 
    else if(snakeBoost && head.x === snakeBoost.x && head.y === snakeBoost.y) { fCollectedBoosts.push({type: snakeBoost.type, icon: snakeBoost.icon}); updateMgLiveBoostsVisual(); updateMissionProgress('mg_boost_collect', 1); playClickSound(); snakeBoost = null; }
    else snake.pop();
    snakeCtx.fillStyle = "#000"; snakeCtx.fillRect(0, 0, 300, 300);
    snakeCtx.fillStyle = "#ff4757"; snakeCtx.beginPath(); snakeCtx.arc(snakeFood.x + 10, snakeFood.y + 10, 8, 0, Math.PI * 2); snakeCtx.fill();
    if(snakeBoost) { snakeCtx.font = "16px Arial"; snakeCtx.textAlign = "center"; snakeCtx.fillText(snakeBoost.icon, snakeBoost.x + 10, snakeBoost.y + 15); }
    snake.forEach((p, i) => { snakeCtx.fillStyle = i === 0 ? varProp('--accent') : "rgba(255,255,255,0.4)"; snakeCtx.fillRect(p.x, p.y, 18, 18); });
}

function varProp(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

function changeSnakeDir(dir) {
    if (dir === 'LEFT' && sdx === 0) { snextDx = -20; snextDy = 0; }
    if (dir === 'UP' && sdy === 0) { snextDx = 0; snextDy = -20; }
    if (dir === 'RIGHT' && sdx === 0) { snextDx = 20; snextDy = 0; }
    if (dir === 'DOWN' && sdy === 0) { snextDx = 0; snextDy = 20; }
}

function initFlight() {
    if(!flightCanvas) return;
    flightCanvas.width = 300; flightCanvas.height = 300; fBeeY = 150; fVelocity = 0; fPipes = []; fBoosts = []; fCollectedBoosts = [];
    if(mgInterval) clearInterval(mgInterval); mgInterval = setInterval(drawFlight, 30);
}

function flightJump() { if(mgRunning && activeMG === 'flight') fVelocity = fJump; }

function spawnFlightBoost(x, gapY, gapH) {
    if(Math.random() > 0.7) return;
    const types = ['pepper', 'energy', 'flower', 'luck']; const icons = { pepper: 'üå∂Ô∏è', energy: 'ü•§', flower: 'üåº', luck: 'üçÄ' }; const type = types[Math.floor(Math.random() * types.length)];
    fBoosts.push({ x: x + 10, y: gapY + (gapH / 2) - 10, type: type, icon: icons[type] });
}

function drawFlight() {
    if(!flightCtx) return;
    fVelocity += fGravity; fBeeY += fVelocity; if(fBeeY < 0 || fBeeY > 285) { finishMG(); return; }
    if(fPipes.length === 0 || fPipes[fPipes.length-1].x < 150) {
        let gap = 110; let topH = Math.random() * (180 - gap) + 20; let newX = 350; fPipes.push({x: newX, topH: topH, gap: gap, passed: false, boostSpawned: false});
        if(mgScore > 0 && mgScore % 50 === 0 && !fPipes[fPipes.length-1].boostSpawned) { spawnFlightBoost(newX, topH, gap); fPipes[fPipes.length-1].boostSpawned = true; }
    }
    flightCtx.fillStyle = "#000"; flightCtx.fillRect(0, 0, 300, 300);
    if(beeSprite.complete) { flightCtx.drawImage(beeSprite, 40, fBeeY, 25, 25); }
    fPipes.forEach((p, i) => {
        p.x -= 3; flightCtx.fillStyle = "rgba(255,255,255,0.2)"; flightCtx.fillRect(p.x, 0, 40, p.topH); flightCtx.fillRect(p.x, p.topH + p.gap, 40, 300);
        if(p.x < 65 && p.x + 40 > 40) if(fBeeY < p.topH || fBeeY + 20 > p.topH + p.gap) { finishMG(); return; }
        if(!p.passed && p.x < 40) { p.passed = true; mgScore++; updateMissionProgress('mg_item_collect', 1); const scoreVal = document.getElementById("mgCurrentScore"); if(scoreVal) scoreVal.textContent = mgScore; }
    });
    fBoosts.forEach((b, i) => {
        b.x -= 3; flightCtx.font = "20px Arial"; flightCtx.fillText(b.icon, b.x, b.y + 15);
        if(b.x < 65 && b.x + 20 > 40 && fBeeY < b.y + 20 && fBeeY + 20 > b.y) { fCollectedBoosts.push(b); updateMgLiveBoostsVisual(); updateMissionProgress('mg_boost_collect', 1); playClickSound(); fBoosts.splice(i, 1); }
    });
    fPipes = fPipes.filter(p => p.x > -50); fBoosts = fBoosts.filter(b => b.x > -50);
}

function finishMG() {
    mgRunning = false; clearInterval(mgInterval); if(dGameTimer) clearInterval(dGameTimer);
    if(mgScore > (records[activeMG] || 0)) { records[activeMG] = mgScore; localStorage.setItem(RECORDS_KEY, JSON.stringify(records)); updateRecordsUI(); }
    if(activeMG === 'defender') { defenderProgress.lastPlayed = Date.now(); executeSave(); }
    updateMissionProgress('mg_session_finished', 1);
    let multiplier = 50; if(activeMG === 'flight') multiplier = 120; if(activeMG === 'rain') multiplier = 180; if(activeMG === 'defender') multiplier = 150; 
    let hGain = mgScore * multiplier * (1 + level * 0.1); let xGain = hGain * 0.20; 
    const scoreVal = document.getElementById("mgResultScore"); if(scoreVal) scoreVal.textContent = mgScore;
    const rewardVal = document.getElementById("mgResultReward"); rewardVal.innerHTML = `+${formatNum(hGain)} üçØ | +${formatNum(xGain)} XP`;
    const boostDisplay = document.getElementById("mgResultBoosts"); if(boostDisplay) { if(fCollectedBoosts.length > 0) { let icons = fCollectedBoosts.map(b => b.icon).join(' '); boostDisplay.innerHTML = `BOOSTS COLETADOS: ${icons} (30s cada)`; } else { boostDisplay.innerHTML = ""; } }
    const resScreen = document.getElementById("mgResultScreen"); if(resScreen) resScreen.style.display = "flex";
    activeMGData = { hGain, xGain, boosts: [...fCollectedBoosts] };
}

let activeMGData = null;

function closeMgResult() { 
    if(activeMGData) { honey = validateNum(honey + activeMGData.hGain); addXP(activeMGData.xGain); activeMGData.boosts.forEach(b => { activeBoosts[b.type] += 300; }); updateUI(); executeSave(); activeMGData = null; }
    const overlay = document.getElementById("minigameOverlay"); if(overlay) overlay.style.display = "none"; 
}

function updateRecordsUI() {
    const rainR = document.getElementById("rainRecordDisplay"); const snakeR = document.getElementById("snakeRecordDisplay"); const flightR = document.getElementById("flightRecordDisplay"); const defL = document.getElementById("defenderLevelDisplay");
    if(rainR) rainR.textContent = records.rain || 0; if(snakeR) snakeR.textContent = records.snake || 0; if(flightR) flightR.textContent = records.flight || 0; if(defL) defL.textContent = defenderProgress.level || 1;
}

function exitMinigame() { clearInterval(mgInterval); mgRunning = false; if(dGameTimer) clearInterval(dGameTimer); const overlay = document.getElementById("minigameOverlay"); if(overlay) overlay.style.display = "none"; }

function updateVolume(type) {
    tryPlayMusic();
    if(type === 'music') { const musicIn = document.getElementById('musicVol'); if(musicIn) { audioSettings.music = musicIn.value; const label = document.getElementById('musicVolLabel'); if(label) label.textContent = audioSettings.music + '%'; soundMusic.volume = audioSettings.music / 100; } }
    else if(type === 'click') { const clickIn = document.getElementById('clickVol'); if(clickIn) { audioSettings.click = clickIn.value; const label = document.getElementById('clickVolLabel'); if(label) label.textContent = audioSettings.click + '%'; soundClick.volume = audioSettings.click / 100; } }
    else if(type === 'lvlUp') { const lvlIn = document.getElementById('lvlUpVol'); if(lvlIn) { audioSettings.lvlUp = lvlIn.value; const label = document.getElementById('lvlUpVolLabel'); if(label) label.textContent = audioSettings.lvlUp + '%'; soundLvlUp.volume = audioSettings.lvlUp / 100; } }
    localStorage.setItem(AUDIO_KEY, JSON.stringify(audioSettings));
}

function applyAudioSettings() {
    soundMusic.volume = (audioSettings.music || 50) / 100; soundClick.volume = (audioSettings.click || 80) / 100; soundLvlUp.volume = (audioSettings.lvlUp || 100) / 100;
    const musicIn = document.getElementById('musicVol'); const musicLab = document.getElementById('musicVolLabel'); if(musicIn) musicIn.value = audioSettings.music; if(musicLab) musicLab.textContent = audioSettings.music + '%'; 
    const clickIn = document.getElementById('clickVol'); const clickLab = document.getElementById('clickVolLabel'); if(clickIn) clickIn.value = audioSettings.click; if(clickLab) clickLab.textContent = audioSettings.click + '%'; 
    const lvlIn = document.getElementById('lvlUpVol'); const lvlLab = document.getElementById('lvlUpVolLabel'); if(lvlIn) lvlIn.value = audioSettings.lvlUp || 100; if(lvlLab) lvlLab.textContent = (audioSettings.lvlUp || 100) + '%';
}

function tryPlayMusic() { if(soundMusic.paused) soundMusic.play().then(() => { window.removeEventListener('click', tryPlayMusic); window.removeEventListener('touchstart', tryPlayMusic); }).catch(() => {}); }
window.addEventListener('click', tryPlayMusic); window.addEventListener('touchstart', tryPlayMusic);

function playClickSound() { soundClick.currentTime = 0; soundClick.play().catch(() => {}); }

function checkFullscreenState() { const isFS = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement; return !!isFS; }
function requestFullscreen() { const doc = window.document, docEl = doc.documentElement; const request = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen; if (request && !checkFullscreenState()) { request.call(docEl).catch(err => { console.warn("Fullscreen negado ou bloqueado:", err.message); }); } }

document.addEventListener('fullscreenchange', handleFSChange); document.addEventListener('webkitfullscreenchange', handleFSChange); document.addEventListener('mozfullscreenchange', handleFSChange); document.addEventListener('MSFullscreenChange', handleFSChange);

function handleFSChange() { if(!checkFullscreenState() && gameLoaded) { console.log("Saiu do modo imersivo."); } }

function returnToMain() {
    closeModal('settingsModal'); if(autoProduceInterval) clearInterval(autoProduceInterval); if(gameTickInterval) clearInterval(gameTickInterval); executeSave(); 
    const loadingScreen = document.getElementById("loadingScreen"); const bar = document.getElementById("loadingBarFill"); const bee = document.getElementById("loadingBeeImg"); if(loadingScreen) loadingScreen.style.display = "flex";
    let progress = 0; const interval = setInterval(() => {
        progress += Math.random() * 8; if(progress > 100) progress = 100; if(bar) bar.style.width = progress + "%"; if(bee) bee.style.left = progress + "%";
        if(progress === 100) { clearInterval(interval); setTimeout(() => { if(loadingScreen) loadingScreen.style.display = "none"; const gameUI = document.getElementById('gameUI'); const startScreen = document.getElementById('startScreen'); if(gameUI) gameUI.style.opacity = '0'; setTimeout(() => { if(gameUI) gameUI.style.display = 'none'; if(startScreen) { startScreen.style.display = 'flex'; startScreen.style.opacity = '1'; } gameLoaded = false; }, 500); }, 300); }
    }, 50);
}

const beeFacts = ["Abelhas polinizam 70% das culturas agr√≠colas do mundo.", "Uma abelha produz 1/12 de colher de ch√° de mel na vida.", "Uma colmeia pode ter at√© 60.000 abelhas no ver√£o."];
const gameTips = ["üí° DICA: O b√¥nus da Skin NoelBee (+10%) √© aplicado no final!", "üí° DICA: Escolha o caminho Alquimista se gosta de Boosts longos!"];
let lastNotifType = "fact"; let notificationQueue = []; let isProcessingNotifs = false;

function notify(a) { notificationQueue.push({ n: a.n, d: a.d ? a.d : "" }); if (!isProcessingNotifs) { processNextNotification(); } }

function processNextNotification() {
    if (notificationQueue.length === 0) { isProcessingNotifs = false; return; }
    isProcessingNotifs = true; const currentNotif = notificationQueue.shift(); const container = document.getElementById("notifContainer"); if(!container) return;
    container.innerHTML = ""; const div = document.createElement("div"); div.className = "popup"; div.textContent = `${currentNotif.n} ${currentNotif.d ? '(' + currentNotif.d + ')' : ''}`;
    container.appendChild(div); div.style.animation = "slideInNotif 8s ease-in-out forwards";
    setTimeout(() => { if(div) div.remove(); processNextNotification(); }, 8000);
}

function startDynamicNotifications() { setInterval(() => { const gameUI = document.getElementById('gameUI'); if (!gameLoaded || !gameUI || gameUI.style.opacity !== '1') return; let msg = lastNotifType === "fact" ? gameTips[Math.floor(Math.random() * gameTips.length)] : "üêù " + beeFacts[Math.floor(Math.random() * beeFacts.length)]; lastNotifType = lastNotifType === "fact" ? "tip" : "fact"; notify({n: msg}); }, 45000); }

const durations = [{label:"30s",t:300,m:1},{label:"1m",t:600,m:1.8},{label:"5m",t:3000,m:8},{label:"1h",t:36000,m:70},{label:"24h",t:864000,m:1200}];
const specialDurations = [{label:"2m",t:1200,m:10}]; 
const boostBases = { pepper: 5, energy: 3, flower: 10, luck: 15, jelly: 150, magnet: 40 }; 
const achievements = [];
const achThemes = [{n:"Aprendiz de P√≥len",r:"common",i:"üå±"},{n:"Batedor de Asas",r:"common",i:"ü™Ω"},{n:"Zumbido Mel√≥dico",r:"common",i:"üéµ"},{n:"Pequeno Apicultor",r:"common",i:"üë®‚Äçüåæ"},{n:"Bar√£o do A√ß√∫car",r:"rare",i:"üíé"},{n:"Arquiduque da Colmeia",r:"rare",i:"üè∞"},{n:"Imperador da Geleia Real",r:"epic",i:"üëë"}];

const missionTemplates = [
    { id: 'm_click', type: 'clicks', title: "Gin√°stica de Asas", desc: "Coletas manuais {target} vezes", baseGoal: 100, rewardMult: 2.2 },
    { id: 'm_honey', type: 'honey_gain', title: "Reserva de Inverno", desc: "Colete {target} de Mel total", baseGoal: 500, rewardMult: 2.5 },
    { id: 'm_target', type: 'target_clicks', title: "Foco Absoluto", desc: "Acerte os alvos üéØ {target} vezes", baseGoal: 30, rewardMult: 3.5 },
    { id: 'm_time', type: 'play_time', title: "Voo de Reconhecimento", desc: "Fique no jogo por {target} segundos", baseGoal: 300, rewardMult: 3.0 },
    { id: 'm_upg', type: 'buy_upgrade', title: "Evolu√ß√£o Necess√°ria", desc: "Aplique talentos {target} vezes", baseGoal: 3, rewardMult: 4.0 },
    { id: 'm_mg_item', type: 'mg_item_collect', title: "Explorador de Games", desc: "Colete {target} itens em minigames", baseGoal: 15, rewardMult: 3.8 },
    { id: 'm_mg_boost', type: 'mg_boost_collect', title: "Ca√ßador de Boosts", desc: "Pegue {target} itens de Boost em minigames", baseGoal: 2, rewardMult: 5.0 },
    { id: 'm_mg_kill', type: 'mg_kills', title: "Exterminador de Insetos", desc: "Abata {target} invasores no Hive Defender", baseGoal: 20, rewardMult: 4.5 },
    { id: 'm_mg_play', type: 'mg_session_finished', title: "F√£ de Entretenimento", desc: "Termine {target} partidas de minijogos", baseGoal: 2, rewardMult: 3.2 },
    { id: 'm_xp', type: 'xp_gain', title: "P√≥len Intelectual", desc: "Acumule {target} de XP total", baseGoal: 1000, rewardMult: 2.8 }
];

function checkMissionReset() {
    const now = new Date(); const resetHour = 22; let resetLimit = new Date(); resetLimit.setHours(resetHour, 0, 0, 0); if (now.getHours() < resetHour) { resetLimit.setDate(resetLimit.getDate() - 1); }
    if (lastMissionReset < resetLimit.getTime()) { let fH = 0, fX = 0; dailyMissions.forEach(m => { if (m.completed && !m.collected) { fH += m.rewardHoney; fX += m.rewardXP; } }); if (fH > 0) { pendingOfflineHoney += fH; pendingOfflineXP += fX; } generateDailyMissions(); lastMissionReset = now.getTime(); executeSave(); }
    else if (!dailyMissions || dailyMissions.length < 10) { generateDailyMissions(); lastMissionReset = now.getTime(); executeSave(); }
}

function generateDailyMissions() {
    dailyMissions = []; const sF = Math.pow(level, 1.2); const shuffled = [...missionTemplates].sort(() => 0.5 - Math.random());
    for(let i=0; i<10; i++) { const tmp = shuffled[i % shuffled.length]; dailyMissions.push(createSingleMission(tmp, sF)); }
}

function createSingleMission(tmp, sF) {
    let target = 0;
    switch(tmp.type) {
        case 'clicks': target = Math.floor(Math.random() * (11000 - 8000 + 1)) + 8000; break;
        case 'target_clicks': target = 40 + (level * 2); break;
        case 'honey_gain': target = Math.floor(Math.random() * (40000 - 30000 + 1)) + 30000; break;
        case 'xp_gain': target = Math.ceil(tmp.baseGoal * sF * 3); break;
        case 'buy_upgrade': target = 3; break;
        case 'play_time': target = Math.ceil(tmp.baseGoal * (1 + level * 0.1)); break;
        case 'mg_item_collect': target = Math.ceil(tmp.baseGoal * (1 + level * 0.05)); break;
        case 'mg_kills': target = Math.ceil(tmp.baseGoal * (1 + level * 0.15)); break;
        case 'mg_boost_collect': target = Math.ceil(tmp.baseGoal); break;
        case 'mg_session_finished': target = Math.ceil(tmp.baseGoal); break;
    }
    const logB = Math.max(1, Math.log10(hPerClick * 100)); const rH = Math.max(target * (hPerClick * 2.5), 600) * tmp.rewardMult * logB; const rX = (nextLevelXP * 0.12) * tmp.rewardMult;
    return { id: tmp.id + Date.now() + Math.random(), type: tmp.type, title: tmp.title, desc: tmp.desc.replace("{target}", formatNum(target)), target, progress: 0, completed: false, collected: false, rewardHoney: rH, rewardXP: rX, rewardLabel: `${formatNum(rH)} üçØ | ${formatNum(rX)} XP` };
}

function updateMissionProgress(type, amt = 1) {
    if (!gameLoaded) return; let changed = false;
    dailyMissions.forEach(m => { if (m.type === type && !m.completed) { m.progress = validateNum(m.progress + amt); if (m.progress >= m.target) { m.progress = m.target; m.completed = true; notify({n: "Miss√£o Realizada!", d: m.title}); } changed = true; } });
    if (changed) { const list = document.getElementById('missionsList'); if (list) renderMissions(); updateMissionAlertStatus(); }
}

function updateMissionAlertStatus() { 
    const hasRewards = dailyMissions.some(m => m.completed && !m.collected); const alertBtn = document.getElementById("btnMissionAlert"); if(!alertBtn) return; 
    if (hasRewards) alertBtn.classList.add("mission-alert"); else alertBtn.classList.remove("mission-alert"); 
}

function openRerollConfirmation(id) { pendingRerollId = id; openModal('rerollModal'); }
const confirmRerollBtn = document.getElementById('btnConfirmReroll');
if(confirmRerollBtn) { confirmRerollBtn.onclick = () => { if (pendingRerollId) { const index = dailyMissions.findIndex(m => m.id === pendingRerollId); if (index !== -1) { const randomTmp = missionTemplates[Math.floor(Math.random() * missionTemplates.length)]; const sF = Math.pow(level, 1.2); dailyMissions[index] = createSingleMission(randomTmp, sF); renderMissions(); updateMissionAlertStatus(); executeSave(); closeModal('rerollModal'); pendingRerollId = null; } } }; }

function collectMissionReward(id) {
    const m = dailyMissions.find(x => x.id === id);
    if (m && m.completed && !m.collected) { m.collected = true; honey = validateNum(honey + m.rewardHoney); addXP(m.rewardXP); notify({n: "Recompensa Coletada!", d: m.rewardLabel}); const allC = dailyMissions.every(x => x.collected); if(allC && dailyMissions.length >= 10) triggerCrownBonus(); renderMissions(); updateMissionAlertStatus(); updateUI(); executeSave(); }
}

function triggerCrownBonus() { activeBoosts.crown = 36000; notify({n: "MESTRE DA COLMEIA! üëë", d: "B√¥nus de 8x ATIVO por 1h!"}); }

function getMissionIcon(type) { switch(type) { case 'clicks': return 'üêù'; case 'honey_gain': return 'üçØ'; case 'target_clicks': return 'üéØ'; case 'buy_upgrade': return 'üöÄ'; case 'xp_gain': return '‚ú®'; case 'play_time': return '‚è≥'; case 'mg_item_collect': return 'üçé'; case 'mg_boost_collect': return 'ü•§'; case 'mg_kills': return 'üî´'; case 'mg_session_finished': return 'üéÆ'; default: return 'üìù'; } }

function renderMissions() {
    const list = document.getElementById("missionsList"); if(!list) return; list.innerHTML = "";
    const sorted = [...dailyMissions].sort((a, b) => { const sA = (a.completed && !a.collected) ? 0 : (!a.completed ? 1 : 2); const sB = (b.completed && !b.collected) ? 0 : (!a.completed ? 1 : 2); return sA - sB; });
    sorted.forEach(m => {
        const perc = Math.min(100, (m.progress / m.target) * 100); const icon = m.collected ? 'üéÅ' : (m.completed ? '‚úÖ' : getMissionIcon(m.type));
        let actB = ''; if (m.completed && !m.collected) { actB = `<button onclick="collectMissionReward('${m.id}')" style="margin-top:8px; padding:8px; background:var(--xp-bar); font-size:12px; height:auto; box-shadow:0 3px 0 #2e7d32;">COLETAR RECOMPENSA</button>`; }
        else if (!m.completed) { actB = `<div class="mission-reroll-btn" onclick="openRerollConfirmation('${m.id}')" title="Trocar Miss√£o">üîÑ</div>`; }
        list.innerHTML += `<div class="mission-card ${m.completed ? 'completed' : ''} ${m.collected ? 'collected' : ''}"><div style="font-size: 24px">${icon}</div><div style="flex: 1"><div style="font-weight: 900; font-size: 14px; color: inherit">${m.title}</div><div style="font-size: 11px; color: inherit; opacity: 0.6;">${m.desc}</div><div class="mission-reward-tag">Pr√™mio: ${m.rewardLabel}</div><div class="mission-progress-bar"><div class="mission-progress-fill" style="width: ${perc}%"></div></div>${actB}</div><div style="font-size: 10px; font-weight: 800; min-width: 50px; text-align: right; padding-right: 5px;">${formatNum(m.progress)}/${formatNum(m.target)}</div></div>`;
    });
}

function formatNum(n) { n = validateNum(n); if (n >= 1e12) return (n/1e12).toFixed(2) + "T"; if (n >= 1e9) return (n/1e9).toFixed(2) + "B"; if (n >= 1e6) return (n/1e6).toFixed(1) + "M"; if (n >= 1000) return (n/1000).toFixed(1) + "K"; return parseFloat(n.toFixed(2)).toString(); }
function formatTime(t) { let s = Math.ceil(t/10); if(s < 60) return s + "s"; let m = Math.floor(s/60); if(m < 60) return m + "m"; return Math.floor(m/60) + "h"; }

function getMPSBase() { if(!autoUnlocked) return 0; let b = (talents.arquiteto_mps * 2.5) + (level * 1.5); if(hiveOwned.middle) b *= 1.5; if(hiveOwned.top) b *= 2.0; if(activeBoosts.jelly > 0) b *= 2; return b; }

function getSkinBonus() { let bonus = 1.0; if(equippedCosmetic === "NoelBee") bonus = 1.10; return bonus; }

function getGlobalBonus() {
    let r = achievements.filter(a => a.u && a.r === 'rare').length, e = achievements.filter(a => a.u && a.r === 'epic').length;
    let b = (1 + (r * 0.01) + (e * 0.05)) * getSkinBonus(); if(activeBoosts.pepper > 0) b += 1; if(activeBoosts.energy > 0) b += 0.5; if(activeBoosts.crown > 0) b *= 8; 
    let biomesActive = new Set(); expeditions.forEach(exp => { if(exp.active) biomesActive.add(exp.biome); });
    if(biomesActive.size >= 2) b += (biomesActive.size * 0.05); return b;
}

function updateUI() {
    honey = validateNum(honey); crowns = validateNum(crowns); honeyBottles = validateNum(honeyBottles);
    const hEl = document.getElementById("honey"), cEl = document.getElementById("crowns"), mpsEl = document.getElementById("mps"), lEl = document.getElementById("lvlDisplay"), xEl = document.getElementById("xpDisplay"), xF = document.getElementById("xpFill");
    if(hEl) hEl.textContent = formatNum(honey); if(cEl) cEl.textContent = formatNum(crowns); if(mpsEl) mpsEl.textContent = formatNum(getMPSBase() * getGlobalBonus()); if(lEl) lEl.textContent = level; if(xEl) xEl.textContent = `${formatNum(currentXP)} / ${formatNum(nextLevelXP)}`; if(xF) xF.style.width = `${Math.min(100, (currentXP / nextLevelXP) * 100)}%`;
    
    const lH = document.getElementById("labHoneyValue"), lB = document.getElementById("labBottlesValue"), bB = document.getElementById("btnBottle");
    if(lH) lH.textContent = formatNum(honey); if(lB) lB.textContent = formatNum(honeyBottles); 
    
    updateMarketVendaUI();

    let cQ = currentBatch; if(currentBatch === 'all') cQ = Math.floor(honey / 750000); const tC = cQ * 750000; const lCL = document.getElementById("batchCostLabel"); if(lCL) lCL.textContent = formatNum(tC) + " üçØ";
    const tF = labSlots.reduce((acc, curr) => acc + (SLOT_CAPACITY - curr), 0); const fPQ = Math.min(cQ, tF);
    if(bB) bB.disabled = (honey < 750000 || isLabWorking || tF <= 0 || fPQ <= 0); 
    hPerClick = 0.2 + (talents.operario_forca * 0.5) + (level * 0.05);
    buildShop(); renderActiveBoosts(); updateRecordsUI(); renderTalentTree();
    ['Bee', 'NoelBee', 'SkullBee', 'FairyBee'].forEach(id => {
        const btn = document.getElementById(`btn_cos_${id}`); if(!btn) return;
        if(equippedCosmetic === id) { btn.innerHTML = `<img src="${id}.png" class="skin-preview"><b>EQUIPADO</b>`; btn.style.background = "var(--xp-bar)"; btn.style.color = "white"; const mB = document.getElementById("mainBeeSprite"), hB = document.getElementById("miniBeeHeader"); if(mB) mB.src = `${id}.png`; if(hB) hB.src = `${id}.png`; }
        else { let lbl = id === "NoelBee" ? "Noel (+10%)" : (id === "SkullBee" ? "Skull (+5% Crit)" : (id === "FairyBee" ? "Fairy (+6% Luck)" : "Comum")); btn.innerHTML = `<img src="${id}.png" class="skin-preview"><b>${lbl}</b>`; btn.style.background = "rgba(255,255,255,0.05)"; btn.style.color = "inherit"; }
    });
    const cZ = document.getElementById("clickZone");
    ['BgPadrao', 'BgCristmas', 'BgRaining', 'BgNight', 'BgLake'].forEach(id => {
        const btn = document.getElementById(`btn_bg_${id}`); if(!btn) return;
        if(equippedBackground === id) { btn.style.background = "var(--accent)"; btn.style.color = "var(--main-blue)"; if(cZ) cZ.style.backgroundImage = `url('${id}.gif')`; } else { btn.style.background = "rgba(255,255,255,0.05)"; btn.style.color = "inherit"; }
    });
    checkUpdateStatus(); updateVersionDisplay(); renderHangars(); renderLabSlots();
    const hP = document.getElementById("hive-stats"); if(hP && hP.classList.contains("active")) renderHiveStats();
}

/* L√ìGICA DE VENDA DIN√ÇMICA MERCADO */
function setMarketSellQty(qty) {
    const input = document.getElementById("marketSellQtyInput");
    const totalAvail = honeyBottles + labSlots.reduce((a, b) => a + b, 0);
    
    document.querySelectorAll(".qty-btn").forEach(b => b.classList.remove("active"));
    
    if(qty === 'all') {
        input.value = totalAvail;
        document.getElementById("marketQtyAll").classList.add("active");
    } else {
        input.value = qty;
        // Tenta achar o bot√£o espec√≠fico
        const btn = Array.from(document.querySelectorAll(".qty-btn")).find(b => b.textContent == qty);
        if(btn) btn.classList.add("active");
    }
    updateMarketVendaUI();
}

function updateMarketVendaUI() {
    const input = document.getElementById("marketSellQtyInput");
    const sBC = document.getElementById("shopBottlesCount");
    const sCVT = document.getElementById("shopCrownValueTotal");
    const preview = document.getElementById("marketSellPreviewValue");
    const btn = document.getElementById("btnSellBottles");

    const totalInLab = labSlots.reduce((a, b) => a + b, 0);
    const totalPossible = honeyBottles + totalInLab;
    let qtyRequested = parseInt(input.value) || 0;

    if(sBC) sBC.textContent = formatNum(totalPossible);
    if(sCVT) sCVT.textContent = formatNum(totalPossible * 10);
    
    if(preview) preview.textContent = formatNum(qtyRequested * 10) + " üëë";
    
    if(btn) btn.disabled = (qtyRequested <= 0 || qtyRequested > totalPossible);
}

function sellBottlesDynamic() {
    const input = document.getElementById("marketSellQtyInput");
    let qtyRequested = parseInt(input.value) || 0;
    const totalInLab = labSlots.reduce((a, b) => a + b, 0);
    const totalPossible = honeyBottles + totalInLab;

    if(qtyRequested > 0 && qtyRequested <= totalPossible) {
        let remainingToSell = qtyRequested;
        
        // 1. Vende do invent√°rio primeiro
        let soldFromInv = Math.min(remainingToSell, honeyBottles);
        honeyBottles -= soldFromInv;
        remainingToSell -= soldFromInv;

        // 2. Se sobrar, retira dos slots do laborat√≥rio
        if(remainingToSell > 0) {
            for(let i=0; i < labSlots.length; i++) {
                if(remainingToSell <= 0) break;
                let fromSlot = Math.min(remainingToSell, labSlots[i]);
                labSlots[i] -= fromSlot;
                remainingToSell -= fromSlot;
            }
        }

        let gain = qtyRequested * 10;
        crowns += gain;
        notify({n: "VENDA REALIZADA! üëë", d: `Vendeu ${qtyRequested} garrafas.`});
        playClickSound();
        updateUI();
        executeSave();
    }
}

function renderLabSlots() {
    const grid = document.getElementById("labSlotsGrid"); if(!grid) return; grid.innerHTML = "";
    labSlots.forEach((count, i) => {
        const slot = document.createElement("div"); slot.className = `lab-slot ${count > 0 ? 'has-bottles' : ''}`; slot.onclick = () => collectFromSlot(i);
        slot.innerHTML = `<span class="slot-icon">${count > 0 ? 'üç∂' : '‚≠ï'}</span><span class="slot-count">${count}/${SLOT_CAPACITY}</span><span class="slot-collect-badge">COLETAR</span>`;
        grid.appendChild(slot);
    });
}

function collectFromSlot(index) { if(labSlots[index] > 0) { honeyBottles += labSlots[index]; notify({n: "COLETADO!", d: `+${labSlots[index]} garrafas`}); labSlots[index] = 0; playClickSound(); updateUI(); executeSave(); } }

function setBatch(qty) {
    currentBatch = qty; document.querySelectorAll(".batch-btn").forEach(b => b.classList.remove("active"));
    const actB = (qty === 'all') ? document.getElementById("batchAll") : document.getElementById("batch" + qty); if(actB) actB.classList.add("active"); updateUI();
}

let bottlesBeingProduced = 0;
function bottleHoney() {
    let cQ = currentBatch; if(currentBatch === 'all') cQ = Math.floor(honey / 750000);
    const tF = labSlots.reduce((acc, curr) => acc + (SLOT_CAPACITY - curr), 0); bottlesBeingProduced = Math.min(cQ, tF); const tC = bottlesBeingProduced * 750000;
    if(honey >= tC && !isLabWorking && bottlesBeingProduced > 0) {
        honey -= tC; isLabWorking = true; labTimeLeft = LAB_PROCESS_TIME;
        const card = document.getElementById("labMachine"), container = document.getElementById("labProgressContainer"), fill = document.getElementById("labProgressFill");
        if(card) card.classList.add("lab-working"); if(container) container.style.display = "block"; if(fill) fill.style.width = "0%";
        playClickSound(); notify({n: "ENVASE EM LOTE...", d: `${bottlesBeingProduced} garrafas.`}); updateUI();
        const process = setInterval(() => {
            labTimeLeft--; const pP = ((LAB_PROCESS_TIME - labTimeLeft) / LAB_PROCESS_TIME) * 100; if(fill) fill.style.width = pP + "%";
            const txt = document.getElementById("labProgressText"); if(txt) txt.textContent = `PROCESSANDO... ${labTimeLeft}s`;
            if(labTimeLeft <= 0) { clearInterval(process); finishBottling(); }
        }, 1000);
    }
}

function finishBottling() {
    isLabWorking = false; let rem = bottlesBeingProduced;
    for(let i=0; i < labSlots.length; i++) { if(rem <= 0) break; let sp = SLOT_CAPACITY - labSlots[i]; let add = Math.min(rem, sp); labSlots[i] += add; rem -= add; }
    bottlesBeingProduced = 0; const card = document.getElementById("labMachine"), container = document.getElementById("labProgressContainer");
    if(card) card.classList.remove("lab-working"); if(container) container.style.display = "none";
    notify({n: "LOTE CONCLU√çDO! üß™", d: "Garrafas nos slots."}); playClickSound(); updateUI(); executeSave();
}

function renderTalentTree() {
    const ptsD = document.getElementById("talentPointsDisplay"); if(ptsD) ptsD.textContent = `PONTOS DISPON√çVEIS: ${talentPoints}`;
    const treeData = [ { tree: 'tree_clicks', key: 'operario_forca', name: 'For√ßa Oper√°ria', icon: 'üí™', desc: '+0.5 Mel por Click' }, { tree: 'tree_clicks', key: 'operario_critico', name: 'Foco Agu√ßado', icon: 'üéØ', desc: '+2% Chance Alvo Cr√≠tico' }, { tree: 'tree_auto', key: 'arquiteto_mps', name: 'Engenharia de Mel', icon: '‚öôÔ∏è', desc: '+2.5 MPS Passivo Base' }, { tree: 'tree_auto', key: 'arquiteto_offline', name: 'Estoques Noturnos', icon: 'üåô', desc: '+5% Ganho Offline' }, { tree: 'tree_luck', key: 'alquimista_sorte', name: 'Destino Real', icon: 'üçÄ', desc: '+1% Sorte Real' }, { tree: 'tree_luck', key: 'alquimista_boost', name: 'Ess√™ncia Duradoura', icon: 'üß™', desc: '+10% Dura√ß√£o Boosts' } ];
    treeData.forEach(t => {
        const cont = document.getElementById(t.tree); if(!cont) return;
        if(!document.getElementById(`talent_${t.key}`)) {
            cont.innerHTML += `<div class="talent-card" id="talent_${t.key}"><div class="talent-icon">${t.icon}</div><div class="talent-info"><div class="talent-name">${t.name}</div><div class="talent-desc">${t.desc}</div></div><div class="talent-points" id="val_${t.key}">0/20</div><button class="talent-btn" onclick="upgradeTalent('${t.key}')">+</button></div>`;
        }
        const valE = document.getElementById(`val_${t.key}`); if(valE) valE.textContent = `${talents[t.key]}/20`;
        const btn = document.querySelector(`#talent_${t.key} .talent-btn`); if(btn) btn.disabled = (talentPoints <= 0 || talents[t.key] >= 20);
    });
}

function upgradeTalent(k) { if(talentPoints > 0 && talents[k] < 20) { talentPoints--; talents[k]++; playClickSound(); updateMissionProgress('buy_upgrade', 1); updateUI(); executeSave(); } }

function resetTalents() {
    const cost = honey * 0.1; if(confirm(`Deseja resetar todos os talentos? Custo: ${formatNum(cost)} üçØ`)) { honey -= cost; talentPoints = level; for(let k in talents) talents[k] = 0; document.getElementById("tree_clicks").innerHTML = ""; document.getElementById("tree_auto").innerHTML = ""; document.getElementById("tree_luck").innerHTML = ""; updateUI(); executeSave(); notify({n: "√Årvore Resetada!"}); }
}

function buyHangar(id) { const cost = HANGAR_COSTS[id]; if(honey >= cost) { honey -= cost; hangarsCount = id + 1; notify({n: "HANGAR ADQUIRIDO! üõ∏", d: `#${id+1} liberado.`}); updateUI(); executeSave(); } }
function selectBiome(hI, bI) { if(expeditions[hI].active || expeditions[hI].finished) return; expeditions[hI].biome = bI; renderHangars(); }
function handleExpEvent(hI) {
    const exp = expeditions[hI]; if(!exp.active || exp.eventChance === 0) return;
    if(exp.eventChance === 1) { notify({n: "VESPAS AFASTADAS! üõ°Ô∏è"}); exp.eventChance = 0; }
    else if(exp.eventChance === 2) { exp.startTime -= 30000; notify({n: "VENTO FAVOR√ÅVEL! üå¨Ô∏è"}); exp.eventChance = 0; }
    renderHangars();
}
function onSliderChange(hI, nV) { expeditions[hI].selectedPerc = parseInt(nV); const lbl = document.getElementById(`expPercLabel_${hI}`); if(lbl) lbl.textContent = nV + '%'; recalculateHangarConstraints(); }
function recalculateHangarConstraints() {
    let cOT = expeditions.reduce((acc, curr) => acc + (curr.active ? curr.reductionPerc : 0), 0);
    for(let i=0; i<4; i++) {
        const exp = expeditions[i]; if(!exp.active && !exp.finished && i < hangarsCount) {
            const slider = document.getElementById(`expSlider_${i}`); if(slider) {
                let aFT = Math.max(0, 95 - cOT); slider.max = aFT; if(parseInt(slider.value) > aFT) { slider.value = aFT; exp.selectedPerc = aFT; const lbl = document.getElementById(`expPercLabel_${i}`); if(lbl) lbl.textContent = aFT + '%'; }
            }
        }
    }
}
function startExpedition(hI) {
    const exp = expeditions[hI]; if(exp.active || exp.finished) return; const slider = document.getElementById(`expSlider_${hI}`), durS = document.getElementById(`expDuration_${hI}`); if(!slider || !durS) return;
    const perc = parseInt(slider.value); let cOT = expeditions.reduce((acc, curr) => acc + (curr.active ? curr.reductionPerc : 0), 0);
    if(cOT + perc > 95) { notify({n: "LIMITE DE ABELHAS! ‚ö†Ô∏è"}); return; }
    const bD = parseInt(durS.value); const pB = Math.min(0.20, (exp.uses || 0) * 0.005); 
    exp.duration = bD * (1 - pB); exp.active = true; exp.reductionPerc = perc; exp.startTime = Date.now(); exp.eventChance = 0; exp.uses = (exp.uses || 0) + 1;
    notify({n: "DECOLAGEM REAL!", d: `Hangar #${hI+1}`}); updateUI(); executeSave();
}
function renderHangars() {
    const cont = document.getElementById("hangarList"), synC = document.getElementById("synergyDisplay"); if(!cont) return; cont.innerHTML = "";
    let biomesActive = new Set(); expeditions.forEach(exp => { if(exp.active) biomesActive.add(exp.biome); });
    if(synC) synC.innerHTML = biomesActive.size >= 2 ? `<div class="exp-synergy-tag">‚ú® SINERGIA: +${(biomesActive.size * 5)}% MEL</div>` : "";
    for(let i=0; i<4; i++) {
        const exp = expeditions[i], isL = i >= hangarsCount, hBox = document.createElement("div"); hBox.className = "hangar-box"; const profL = Math.floor((exp.uses || 0) / 10);
        let content = `<div class="hangar-title">HANGAR #${i+1} [Niv. ${profL}] ${isL ? 'üîí' : ''}</div>`;
        if(isL) content += `<div class="hangar-lock"><button onclick="buyHangar(${i})" ${honey < HANGAR_COSTS[i] ? 'disabled' : ''}>LIBERAR: ${formatNum(HANGAR_COSTS[i])} üçØ</button></div>`;
        else if(exp.finished) content += `<div class="exp-result-inline" style="display:block;"><div style="font-size: 11px; text-align: center; margin-bottom: 8px;">${exp.pendingRewards.msg}</div><button onclick="collectExpeditionRewards(${i})" style="background: var(--xp-bar); height:auto; padding:8px;">COLETAR</button></div>`;
        else if(exp.active) content += `<div style="text-align:center;"><span class="expedition-timer" id="expTimer_${i}">--:--</span><div class="exp-event-area" id="expEventArea_${i}"><button class="exp-event-btn" onclick="handleExpEvent(${i})" id="expEventBtn_${i}"></button></div></div>`;
        else {
            let cOT = expeditions.reduce((acc, curr) => acc + (curr.active ? curr.reductionPerc : 0), 0); let aFT = Math.max(0, 95 - cOT); let sSP = Math.min(exp.selectedPerc || 50, aFT);
            content += `<div class="biome-selector"><div class="biome-btn ${exp.biome==='clover'?'selected':''}" onclick="selectBiome(${i}, 'clover')"><span class="biome-icon">üçÄ</span><small>Trevo</small></div><div class="biome-btn ${exp.biome==='pepper'?'selected':''}" onclick="selectBiome(${i}, 'pepper')"><span class="biome-icon">üå∂Ô∏è</span><small>Pimenta</small></div><div class="biome-btn ${exp.biome==='orchard'?'selected':''}" onclick="selectBiome(${i}, 'orchard')"><span class="biome-icon">üçé</span><small>Pomar</small></div></div><select id="expDuration_${i}" style="width:100%; margin-top:8px; padding:8px; border-radius:10px; background:rgba(0,0,0,0.2); color:white; border:none; font-size:11px;"><option value="300000">5 Minutos</option><option value="1800000">30 Minutos</option><option value="3600000">1 Hora</option></select><input type="range" id="expSlider_${i}" min="10" max="${aFT}" value="${sSP}" step="10" oninput="onSliderChange(${i}, this.value)"><div style="display:flex; justify-content:space-between; font-size:10px; margin-top:5px;"><span>Enxame:</span> <b id="expPercLabel_${i}">${sSP}%</b></div><button onclick="startExpedition(${i})" style="background:var(--xp-bar); padding:10px; font-size:12px;">INICIAR üöÄ</button>`;
        }
        hBox.innerHTML = content; cont.appendChild(hBox);
    }
}

function buyHiveModule(m) { const cost = HIVE_COSTS[m]; if(honey >= cost) { honey -= cost; hiveOwned[m] = true; notify({n: "EXPANDIDA! üè†", d: m}); updateUI(); executeSave(); } }
function upgradeQueenFertility() {
    const cost = (queenProductionLevel + 1) * 750000; if(queenProductionLevel >= 7) return;
    if(honey >= cost) { honey -= cost; queenProductionLevel++; notify({n: "RAINHA NUTRIDA! üëë", d: `Limite: ${800 + (queenProductionLevel * 200)}`}); updateUI(); executeSave(); }
}
function renderHiveStats() {
    const cont = document.getElementById("hiveStatsContent"); if(!cont) return;
    let mQ = 800 + (queenProductionLevel * 200); let nPC = (queenProductionLevel + 1) * 750000; let tO = expeditions.reduce((acc, curr) => acc + (curr.active ? curr.reductionPerc : 0), 0);
    let sB = Math.round((getSkinBonus() - 1) * 100); let tGM = (getGlobalBonus()).toFixed(2);
    let boostsH = ""; const icons = { pepper: 'üå∂Ô∏è', energy: 'ü•§', flower: 'üåº', luck: 'üçÄ', crown: 'üëë', jelly: 'üß™', magnet: 'üß≤' }, names = { pepper: 'Mel 2x', energy: 'Vel 1.5x', flower: 'XP 3x', luck: 'Sorte 2x', crown: 'Rei 8x', jelly: 'Geleia 2x', magnet: '√çm√£ Alvos' };
    for(let b in activeBoosts) if(activeBoosts[b] > 0) boostsH += `<div class="hive-stat-row"><div class="hive-stat-label">${icons[b]} ${names[b]}</div><div class="hive-stat-val" style="color:#fff;">${formatTime(activeBoosts[b])}</div></div>`;
    cont.innerHTML = `<div class="modular-hive-container"><img src="HiveTop.png" class="hive-module ${!hiveOwned.top ? 'hive-module-hidden' : ''}"><img src="HiveMidle.png" class="hive-module ${!hiveOwned.middle ? 'hive-module-hidden' : ''}"><img src="HiveBase.png" class="hive-module"></div><div id="hiveShopArea" style="margin-bottom: 20px;">${!hiveOwned.middle ? `<button onclick="buyHiveModule('middle')" ${honey < HIVE_COSTS.middle ? 'disabled' : ''}>COMPRAR MEIO: ${formatNum(HIVE_COSTS.middle)} üçØ</button>` : ''}${hiveOwned.middle && !hiveOwned.top ? `<button onclick="buyHiveModule('top')" ${honey < HIVE_COSTS.top ? 'disabled' : ''}>COMPRAR TOPO: ${formatNum(HIVE_COSTS.top)} üçØ</button>` : ''}<div class="section-title">RAINHA üß™</div><div class="card" style="margin-bottom: 10px; padding: 15px;"><div style="font-size: 24px; font-weight: 900; color: var(--accent);">${mQ} ABELHAS</div>${queenProductionLevel < 7 ? `<button onclick="upgradeQueenFertility()" ${honey < nPC ? 'disabled' : ''} style="font-size:12px; height:auto; padding:10px; background:var(--xp-bar);">NUTRIR RAINHA: ${formatNum(nPC)} üçØ</button>` : '<div style="font-size: 11px; color: gold; font-weight: 900; margin-top: 10px;">LIMITE ALCAN√áADO!</div>'}</div></div><div class="section-title">POPULA√á√ÉO üêù</div><div class="card" style="margin-bottom: 20px;"><div style="font-size: 32px; font-weight: 900; color: var(--accent);">${tO}%</div><div class="xp-bg" style="margin-top: 15px;"><div class="xp-fill" style="width: ${(tO / 95) * 100}%;"></div></div></div><div class="hive-stat-row"><div class="hive-stat-label">üõ°Ô∏è Sorte Real Total</div><div class="hive-stat-val">${(0.1 + (talents.alquimista_sorte)*1.0).toFixed(2)}%</div></div><div class="hive-stat-row"><div class="hive-stat-label">üëî B√¥nus de Visual</div><div class="hive-bonus-badge">+${sB}%</div></div><div class="hive-stat-row"><div class="hive-stat-label">üìä Multiplicador Global</div><div class="hive-stat-val" style="color: var(--xp-bar);">${tGM}x</div></div>`;
}

function tickExpedition() {
    expeditions.forEach((exp, i) => {
        if(!exp.active) return; const now = Date.now(); const elap = now - exp.startTime; const rem = exp.duration - elap;
        if(rem <= 0) finishExpedition(i);
        else { const tE = document.getElementById(`expTimer_${i}`); if(tE) { const m = Math.floor(rem / 60000), s = Math.floor((rem % 60000) / 1000); tE.textContent = m.toString().padStart(2, '0') + ":" + s.toString().padStart(2, '0'); } }
    });
}
function finishExpedition(hI) {
    const exp = expeditions[hI]; exp.active = false; exp.finished = true;
    const pL = 800 + (queenProductionLevel * 200); const eP = Math.min(2400, pL); const power = (hPerClick * exp.reductionPerc * (eP / 2)); let hG = power, xG = hG * 0.15, msg = "";
    if(Math.random() < 0.05) { const t = Math.random() < 0.5 ? 'jelly' : 'magnet'; activeBoosts[t] += 1200; msg += "üéÅ BA√ö REAL!<br>"; }
    if(exp.biome === 'clover') hG *= 0.8; else if(exp.biome === 'pepper') hG *= 1.5; else if(exp.biome === 'orchard') xG *= 2;
    msg += `<b>RECOMPENSAS:</b><br>üçØ ${formatNum(hG)} | ‚ú® ${formatNum(xG)}`;
    exp.pendingRewards = {h: hG, x: xG, msg}; updateUI(); executeSave();
}
function collectExpeditionRewards(hI) { const exp = expeditions[hI]; if(exp.pendingRewards) { honey += exp.pendingRewards.h; addXP(exp.pendingRewards.x); notify({n: "Carga Coletada!"}); } exp.finished = false; exp.pendingRewards = null; updateUI(); executeSave(); }

function renderActiveBoosts() { 
    const cont = document.getElementById("active-boosts"); if(!cont) return; cont.innerHTML = ""; const icons = { pepper: 'üå∂Ô∏è', energy: 'ü•§', flower: 'üåº', luck: 'üçÄ', crown: 'üëë', jelly: 'üß™', magnet: 'üß≤' }; 
    if(equippedCosmetic === "NoelBee") cont.innerHTML += `<div class="active-boost-timer active-boost-passive"><span>üéÑ</span> <span>10%</span></div>`;
    if(equippedCosmetic === "SkullBee") cont.innerHTML += `<div class="active-boost-timer active-boost-passive"><span>üíÄ</span> <span>5%</span></div>`;
    if(equippedCosmetic === "FairyBee") cont.innerHTML += `<div class="active-boost-timer active-boost-passive"><span>‚ú®</span> <span>6%</span></div>`;
    for(let k in activeBoosts) if(activeBoosts[k] > 0) cont.innerHTML += `<div class="active-boost-timer"><span>${icons[k]}</span> <span>${formatTime(activeBoosts[k])}</span></div>`; 
}

function spawnFloatingNumber(amt, isT, isSC) {
    const bee = document.getElementById("mainBeeSprite"); if(!bee) return; const rect = bee.getBoundingClientRect(); const cX = rect.left + (rect.width / 2), cY = rect.top + (rect.height / 2);
    const cont = document.createElement("div"); cont.className = "floating-num-container"; const nE = document.createElement("div"); nE.className = "floating-num"; nE.textContent = `+${formatNum(amt)}`;
    if(isSC) { nE.style.color = "#ff4757"; nE.style.fontSize = "38px"; const lbl = document.createElement("div"); lbl.className = "super-critical-label"; lbl.textContent = "SORTE REAL! (5x)"; cont.appendChild(nE); cont.appendChild(lbl); } else { if(isT) nE.style.color = "#ffcc00"; cont.appendChild(nE); }
    cont.style.left = `${cX}px`; cont.style.top = `${cY}px`; document.body.appendChild(cont); setTimeout(() => cont.remove(), 800);
}

function spawnHoneyParticles(isSC) {
    const bee = document.getElementById("mainBeeSprite"); if(!bee) return; const rect = bee.getBoundingClientRect(); const cX = rect.left + (rect.width / 2), cY = rect.top + (rect.height / 2);
    const count = isSC ? 20 : 8; for(let i=0; i<count; i++) {
        const p = document.createElement("div"); p.className = "honey-particle"; if(isSC) p.style.background = "#ff4757"; p.style.left = `${cX}px`; p.style.top = `${cY}px`; const tx = (Math.random() - 0.5) * (isSC ? 300 : 180), ty = (Math.random() - 0.5) * (isSC ? 300 : 180); p.style.setProperty('--tx', `${tx}px`); p.style.setProperty('--ty', `${ty}px`); document.body.appendChild(p); setTimeout(() => p.remove(), 500);
    }
}

function triggerImpact(isT, isSC) {
    const card = document.getElementById("clickCard"), stats = document.getElementById("statsCard"); if(!card || !stats) return; let sC = isSC ? 0.90 : (isT ? 0.96 : 0.98); card.style.transform = isT ? `scale(${sC}) rotate(2deg)` : `scale(${sC}) translateY(2px)`; stats.style.transform = `scale(${isSC ? 1.10 : 1.01})`; setTimeout(() => { card.style.transform = "scale(1) rotate(0deg)"; stats.style.transform = "scale(1)"; }, isSC ? 150 : 50);
}

function doClick(e, isT = false) { 
    if (gameLoaded && !checkFullscreenState()) requestFullscreen();
    playClickSound(); let bC = 0.001 + (talents.alquimista_sorte * 0.01); if(equippedCosmetic === "SkullBee") bC += 0.05; if(equippedCosmetic === "FairyBee") bC += 0.06; if(activeBoosts.luck > 0) bC *= 2;
    const isSC = Math.random() < bC; let mult = (isT ? (2 + talents.operario_critico*0.1) : 1) * (isSC ? 5 : 1);
    let tR = expeditions.reduce((acc, curr) => acc + (curr.active ? curr.reductionPerc : 0), 0); let eM = (100 - Math.min(95, tR)) / 100;
    let cV = hPerClick; if(activeBoosts.jelly > 0) cV *= 2; const g = cV * getGlobalBonus() * mult * eM;
    honey = validateNum(honey + g); totalHoneyEver = validateNum(totalHoneyEver + g); addXP(g); updateMissionProgress('honey_gain', g); if(isT) updateMissionProgress('target_clicks', 1); else updateMissionProgress('clicks', 1);
    const beeC = document.getElementById("beeContainer"); if(beeC) { beeC.style.transform = isSC ? "scale(0.60)" : "scale(0.80)"; setTimeout(() => beeC.style.transform = "scale(1)", 50); }
    spawnFloatingNumber(g, isT, isSC); spawnHoneyParticles(isSC); triggerImpact(isT, isSC); clickBuffer.push(Date.now()); spawnFlake('gameSnowContainer'); updateUI(); 
}

function addXP(amt) { 
    let m = ((activeBoosts.flower > 0) ? 3 : 1) * getSkinBonus(); let xG = validateNum(amt * 0.15 * m); currentXP = validateNum(currentXP + xG); updateMissionProgress('xp_gain', xG);
    while(currentXP >= nextLevelXP){ currentXP = validateNum(currentXP - nextLevelXP); level++; talentPoints++; nextLevelXP = Math.floor(nextLevelXP * 1.35); triggerLevelUpCelebration(); }
}
function triggerLevelUpCelebration() { soundLvlUp.currentTime = 0; soundLvlUp.play().catch(() => {}); notify({n:`N√≠vel Real ${level}!`, d:"+1 Ponto de Talento"}); const card = document.getElementById("statsCard"); if(card) { card.classList.add("lvl-up-flash"); setTimeout(() => card.classList.remove("lvl-up-flash"), 1000); } spawnLevelUpFireworks(); }
function spawnLevelUpFireworks() {
    const count = 30; const colors = ['#ffcc00', '#ffffff', '#fffa65', '#fff200']; for(let i=0; i<count; i++) {
        const p = document.createElement("div"); p.className = "honey-particle"; p.style.background = colors[Math.floor(Math.random() * colors.length)]; p.style.width = (Math.random() * 10 + 5) + "px"; p.style.height = p.style.width; p.style.left = "50vw"; p.style.top = "50vh"; const angle = Math.random() * Math.PI * 2, velocity = Math.random() * 400 + 200, tx = Math.cos(angle) * velocity, ty = Math.sin(angle) * velocity; p.style.setProperty('--tx', `${tx}px`); p.style.setProperty('--ty', `${ty}px`); document.body.appendChild(p); setTimeout(() => p.remove(), 1000);
    }
}

function buyBoostManual(type, ticks, cost, label) { cost = validateNum(cost); if(crowns >= cost) { crowns = validateNum(crowns - cost); let dB = 1 + (talents.alquimista_boost * 0.1); activeBoosts[type] += (ticks * dB); notify({n: "Infus√£o Ativa!", d: `+${label}`}); updateUI(); executeSave(); } }

function startAutoProducing() { if(autoProduceInterval) clearInterval(autoProduceInterval); autoProduceInterval = setInterval(() => { if(autoUnlocked){ let g = getMPSBase() * getGlobalBonus(); honey = validateNum(honey + g); totalHoneyEver = validateNum(totalHoneyEver + g); addXP(g); updateMissionProgress('honey_gain', g); } }, 1000); }

function startGameTicks() { 
    if(gameTickInterval) clearInterval(gameTickInterval); gameTickInterval = setInterval(() => { 
        if(!gameLoaded) return; const now = Date.now(); achievements.forEach(a => { if(!a.u && totalHoneyEver >= a.target){ a.u = true; notify(a); executeSave(); } }); 
        for(let b in activeBoosts) if(activeBoosts[b] > 0) activeBoosts[b]--; 
        for(let b in activeBoosts) { const el = document.getElementById(`status_${b}`); if(el) el.textContent = activeBoosts[b] > 0 ? `Ativo: ${formatTime(activeBoosts[b])}` : "Inativo"; } 
        if(now % 1000 < 150) { updateUI(); checkMissionReset(); updateMissionProgress('play_time', 1); tickExpedition(); handleMagnetEffect(); } 
    }, 100); 
}

function handleMagnetEffect() { if(activeBoosts.magnet <= 0) return; const lT = document.getElementById("leftTarget"), rT = document.getElementById("rightTarget"); if(lT && rT) { lT.style.transform = "translateX(25px)"; rT.style.transform = "translateX(-25px)"; } }

function executeSave(){ const data = {honey: validateNum(honey), crowns: validateNum(crowns), honeyBottles: validateNum(honeyBottles), totalHoneyEver: validateNum(totalHoneyEver), level, currentXP, nextLevelXP, talents, talentPoints, activeBoosts, equippedCosmetic, equippedBackground, hiveOwned, queenProductionLevel, achs: achievements.map(a => a.u), timestamp: Date.now(), defenderProgress, pendingOfflineHoney, pendingOfflineXP, hangarsCount, expeditions, ownedCosmetics, labSlots}; localStorage.setItem(SAVE_KEY, JSON.stringify(data)); const missionD = {dailyMissions, lastMissionReset}; localStorage.setItem(MISSION_KEY, JSON.stringify(missionD)); localStorage.setItem(THEME_KEY, JSON.stringify(themeSettings)); localStorage.setItem(DAILY_REWARD_KEY, JSON.stringify(dailyState)); const indicator = document.getElementById("saveIndicator"); if(indicator) { indicator.classList.add("visible"); setTimeout(() => indicator.classList.remove("visible"), 1000); } }

function checkOfflineGains(lastT) { 
    if (!lastT) return; const now = Date.now(); let diff = Math.floor((now - lastT) / 1000); if (diff < 120) return; if (diff > 86400) diff = 86400; 
    const oE = 0.5 + (talents.arquiteto_offline * 0.025); const mR = getMPSBase() * getGlobalBonus(); pendingOfflineHoney = Math.floor(mR * diff * oE); pendingOfflineXP = Math.floor(pendingOfflineHoney * 0.15); 
    const hV = document.getElementById("offlineHoneyVal"), xV = document.getElementById("offlineXpVal"), tV = document.getElementById("offlineTimeText");
    if(hV) hV.textContent = "+" + formatNum(pendingOfflineHoney); if(xV) xV.textContent = "+" + formatNum(pendingOfflineXP); if(tV) { let hrs = Math.floor(diff / 3600), mins = Math.floor((diff % 3600) / 60); tV.textContent = `Voc√™ esteve fora por: ${hrs}h ${mins}m`; }
}
function collectOfflineRewards() { honey = validateNum(honey + pendingOfflineHoney); totalHoneyEver = validateNum(totalHoneyEver + pendingOfflineHoney); addXP(pendingOfflineXP); pendingOfflineHoney = 0; pendingOfflineXP = 0; closeModal('offlineModal'); updateUI(); executeSave(); checkDailyLogic(); }
function checkDailyLogic() { const now = new Date(); const todayStr = now.toDateString(), lastStr = new Date(dailyState.lastClaim).toDateString(); if (todayStr !== lastStr) { const diffT = now.getTime() - dailyState.lastClaim, diffD = Math.floor(diffT / (1000 * 60 * 60 * 24)); if (diffD > 1) dailyState.streak = 0; dailyState.claimedToday = false; renderDailyGrid(); openModal('dailyRewardModal'); } }
function renderDailyGrid() { const grid = document.getElementById('dailyGrid'); if(!grid) return; grid.innerHTML = ""; dailyCycle.forEach((item, i) => { let s = i < dailyState.streak ? 'claimed' : (i === dailyState.streak ? 'active' : ''); let vT = item.type === 'honey' ? formatNum(item.val) : (item.type === 'xp' ? formatNum(item.val) + 'xp' : item.label); grid.innerHTML += `<div class="day-card ${s}"><span class="day-num">DIA ${i+1}</span><span class="day-icon">${item.icon}</span><span class="day-reward-val">${vT}</span></div>`; }); const cB = document.getElementById('btnClaimDaily'); if(cB) { cB.disabled = dailyState.claimedToday; cB.textContent = dailyState.claimedToday ? "COLETADO" : "RESGATAR"; } }
function claimDailyReward() { if (dailyState.claimedToday) return; const r = dailyCycle[dailyState.streak]; if (r.type === 'honey') honey += r.val; else if (r.type === 'xp') addXP(r.val); else if (r.type === 'boost' || r.type === 'super') { if (r.val) honey += r.val; activeBoosts[r.boost] += r.ticks; } dailyState.lastClaim = Date.now(); dailyState.streak = (dailyState.streak + 1) % 7; dailyState.claimedToday = true; notify({n: "Pr√™mio di√°rio!"}); updateUI(); executeSave(); renderDailyGrid(); setTimeout(() => closeModal('dailyRewardModal'), 800); }
function handleCosmetic(id) { if(!ownedCosmetics.includes(id)) { let price = id === "FairyBee" ? 250000 : 100000; if(honey >= price) { honey -= price; ownedCosmetics.push(id); notify({n: "Visual Adquirido!", d: id}); } else return; } equippedCosmetic = id; updateUI(); executeSave(); }
function handleBackground(id) { equippedBackground = id; updateUI(); executeSave(); }

function load(){ 
    initAchievements(); const sA = localStorage.getItem(AUDIO_KEY); if(sA) audioSettings = JSON.parse(sA); applyAudioSettings(); 
    const sT = localStorage.getItem(THEME_KEY); if(sT) { themeSettings = JSON.parse(sT); applyTheme(); } 
    const sR = localStorage.getItem(RECORDS_KEY); if(sR) records = JSON.parse(sR); const sD = localStorage.getItem(DAILY_REWARD_KEY); if(sD) dailyState = JSON.parse(sD); 
    const rM = localStorage.getItem(MISSION_KEY); if(rM) { const md = JSON.parse(rM); dailyMissions = md.dailyMissions || []; lastMissionReset = md.lastMissionReset || 0; } 
    const raw = localStorage.getItem(SAVE_KEY); 
    if(raw){ try { const d = JSON.parse(raw); honey = validateNum(d.honey); crowns = validateNum(d.crowns || 0); honeyBottles = validateNum(d.honeyBottles || 0); totalHoneyEver = validateNum(d.totalHoneyEver); level = d.level || 1; currentXP = validateNum(d.currentXP); nextLevelXP = validateNum(d.nextLevelXP) || 1000; if(d.talents) talents = d.talents; if(d.talentPoints !== undefined) talentPoints = d.talentPoints; if(d.queenProductionLevel !== undefined) queenProductionLevel = d.queenProductionLevel; if(d.hangarsCount) hangarsCount = d.hangarsCount; if(d.expeditions) expeditions = d.expeditions; if(d.ownedCosmetics) ownedCosmetics = d.ownedCosmetics; if(d.activeBoosts) activeBoosts = d.activeBoosts; if(d.equippedCosmetic) equippedCosmetic = d.equippedCosmetic; if(d.equippedBackground) equippedBackground = d.equippedBackground; if(d.hiveOwned) hiveOwned = d.hiveOwned; if(d.achs) d.achs.forEach((u, i) => { if(achievements[i]) achievements[i].u = u; }); if(d.defenderProgress) defenderProgress = d.defenderProgress; if(d.labSlots) labSlots = d.labSlots; if(d.timestamp) checkOfflineGains(d.timestamp); } catch(e) {} } else { talentPoints = level; }
    checkMissionReset(); updateUI(); updateVersionDisplay(); checkUpdateStatus(); 
}

function enterGame() { 
    load(); tryPlayMusic(); requestFullscreen(); const loadingScreen = document.getElementById("loadingScreen"); const bar = document.getElementById("loadingBarFill"), bee = document.getElementById("loadingBeeImg"); if(loadingScreen) loadingScreen.style.display = "flex"; 
    let p = 0; const interval = setInterval(() => { p += Math.random() * 5; if(p > 100) p = 100; if(bar) bar.style.width = p + "%"; if(bee) bee.style.left = p + "%"; if(p === 100) { clearInterval(interval); setTimeout(() => { if(loadingScreen) loadingScreen.style.display = "none"; const startScreen = document.getElementById('startScreen'), gameUI = document.getElementById('gameUI'); if(startScreen) startScreen.style.display = 'none'; if(gameUI) { gameUI.style.display = 'flex'; gameUI.style.opacity = '1'; } gameLoaded = true; if(pendingOfflineHoney > 10) openModal('offlineModal'); else checkDailyLogic(); startGameTicks(); startAutoProducing(); updateUI(); startDynamicNotifications(); }, 300); } }, 50); 
}

function openModal(id) { const m = document.getElementById(id); if(!m) return; m.style.display = 'flex'; if(id === 'missionsModal') renderMissions(); if(id === 'dailyRewardModal') renderDailyGrid(); }
function closeModal(id) { const m = document.getElementById(id); if(m) m.style.display = 'none'; }
function openTab(id, btn) { togglePanel(true); document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); const pane = document.getElementById(id); if(pane) pane.classList.add('active'); if(btn) btn.classList.add('active'); if(id === 'achievements') renderAchs(); if(id === 'hive-stats') renderHiveStats(); if(id === 'talents') renderTalentTree(); }
function openSubShop(id, btn) { document.querySelectorAll('.sub-shop-pane').forEach(p => p.style.display = 'none'); document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active')); const p = document.getElementById('shop_'+id); if(p) p.style.display = 'block'; if(btn) btn.classList.add('active'); }
function setAchFilter(r, btn) { currentAchFilter = r; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); renderAchs(); }

function buildShop() { 
    const boostsData = [
        { type: 'pepper', name: 'Ess√™ncia de Pimenta', icon: 'üå∂Ô∏è', desc: 'Dobra o ganho de mel total.' },
        { type: 'energy', name: 'N√©ctar Energ√©tico', icon: 'ü•§', desc: 'Aumenta a velocidade de coleta em 1.5x.' },
        { type: 'flower', name: 'P√≥len de Girassol', icon: 'üåº', desc: 'Triplica o ganho de experi√™ncia (XP).' },
        { type: 'luck', name: 'Trevo Alqu√≠mico', icon: 'üçÄ', desc: 'Dobra a sorte real (Cr√≠ticos).' },
        { type: 'jelly', name: 'Geleia Imperial', icon: 'üß™', desc: 'Dobra a for√ßa de todos os talentos.' },
        { type: 'magnet', name: 'Magnetismo de Pr√≥polis', icon: 'üß≤', desc: 'Atrai os alvos para o centro da colmeia.' }
    ];

    const container = document.getElementById('boosts_container_new');
    if(!container) return;
    container.innerHTML = "";

    boostsData.forEach(boost => {
        const activeTicks = activeBoosts[boost.type];
        const statusText = activeTicks > 0 ? `<span style="color:var(--xp-bar)">ATIVO: ${formatTime(activeTicks)}</span>` : "DISPON√çVEL";
        
        const card = document.createElement("div");
        card.className = "shop-card-item";
        
        let durList = (boost.type === 'jelly' || boost.type === 'magnet') ? specialDurations : durations;
        
        let buttonsHtml = "";
        durList.forEach(d => {
            const cost = Math.max(1, Math.floor(boostBases[boost.type] * d.m));
            const isDisabled = crowns < cost;
            buttonsHtml += `
                <button class="btn-buy-tiny" onclick="buyBoostManual('${boost.type}', ${d.t}, ${cost}, '${d.label}')" ${isDisabled ? 'disabled' : ''}>
                    <span>${d.label}</span>
                    <span>${formatNum(cost)} üëë</span>
                </button>`;
        });

        card.innerHTML = `
            <div class="shop-card-icon">${boost.icon}</div>
            <div class="shop-card-info">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="shop-card-title">${boost.name}</div>
                    <div style="font-size:8px; font-weight:900; opacity:0.8;">${statusText}</div>
                </div>
                <div class="shop-card-desc">${boost.desc}</div>
                <div class="shop-card-grid-btns">${buttonsHtml}</div>
            </div>
        `;
        container.appendChild(card);
    });
}
function renderAchs() { const l = document.getElementById("achList"); if(!l) return; l.innerHTML = ""; achievements.filter(a => currentAchFilter === 'all' || a.r === currentAchFilter).forEach(a => { l.innerHTML += `<div class="ach-card ${a.u ? 'unlocked ' + a.r : 'locked'}"><div style="font-size:24px;">${a.u ? a.i : 'üîí'}</div><div style="flex:1"><div style="font-weight:900; font-size:13px;">${a.n}</div><div style="font-size:11px; opacity: 0.7;">${a.d}</div></div>${a.u ? '<div style="color:var(--xp-bar)">‚úî</div>' : ''}</div>`; }); }

const beeCont = document.getElementById("beeContainer"); 
if(beeCont) { beeCont.addEventListener("mousedown", (e) => { e.preventDefault(); doClick(e, false); }); beeCont.addEventListener("touchstart", (e) => { e.preventDefault(); doClick(e, false); }, {passive: false}); }
const leftT = document.getElementById("leftTarget"); if(leftT) { leftT.addEventListener("mousedown", (e) => { e.preventDefault(); doClick(e, true); }); leftT.addEventListener("touchstart", (e) => { e.preventDefault(); doClick(e, true); }, {passive: false}); }
const rightT = document.getElementById("rightTarget"); if(rightT) { rightT.addEventListener("mousedown", (e) => { e.preventDefault(); doClick(e, true); }); rightT.addEventListener("touchstart", (e) => { e.preventDefault(); doClick(e, true); }, {passive: false}); }

function spawnFlake(cI) { const c = document.getElementById(cI); if(!c) return; const f = document.createElement('div'); f.className = 'snowflake'; f.innerHTML = '‚ùÑ'; f.style.left = (Math.random() * 95) + 'vw'; f.style.opacity = Math.random(); f.style.animationDuration = (Math.random() * 3 + 3) + 's'; c.appendChild(f); setTimeout(() => f.remove(), 6000); }
setInterval(() => spawnFlake('snowContainer'), 300);
setInterval(() => { const gUI = document.getElementById('gameUI'); if(gameLoaded && gUI && gUI.style.opacity == '1') spawnFlake('gameSnowContainer'); }, 400);

function initAchievements() { achievements.length = 0; for(let i=1; i<=200; i++) { let val = Math.pow(1.65, i) * 150, theme = achThemes[i % achThemes.length]; achievements.push({id:i,n:`${theme.n} ${Math.ceil(i/achThemes.length)}`,d:`Produziu ${formatNum(val)} mel`,target:val,u:false,r:i < 80 ? "common" : (i < 160 ? "rare" : "epic"),i:theme.i}); } }
load();
</script>
</body> 
</html>